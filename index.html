<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전자책 에디터 - Miricanvas Style</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poor+Story&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Stylish&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Single+Day&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Hi+Melody&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Sunflower:wght@300;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Do+Hyeon&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Cute+Font&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@300;400;700&display=swap');
        
        /* Local Font Declarations */
        
        /* Paperlogy Font Family */
        @font-face {
            font-family: 'Paperlogy';
            src: url('./fonts/Paperlogy-1Thin.woff') format('woff');
            font-weight: 100;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('./fonts/Paperlogy-2ExtraLight.woff') format('woff');
            font-weight: 200;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('./fonts/Paperlogy-3Light.woff') format('woff');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('./fonts/Paperlogy-4Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('./fonts/Paperlogy-5Medium.woff') format('woff');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('./fonts/Paperlogy-6SemiBold.woff') format('woff');
            font-weight: 600;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('./fonts/Paperlogy-7Bold.woff') format('woff');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('./fonts/Paperlogy-8ExtraBold.woff') format('woff');
            font-weight: 800;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('./fonts/Paperlogy-9Black.woff') format('woff');
            font-weight: 900;
            font-style: normal;
        }
        
        /* System Fonts - Korean */
        @font-face {
            font-family: 'Apple Gothic';
            src: url('./fonts/AppleGothic.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Apple Myungjo';
            src: url('./fonts/AppleMyungjo.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        /* System Fonts - English */
        @font-face {
            font-family: 'American Typewriter';
            src: url('./fonts/AmericanTypewriter.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Baskerville';
            src: url('./fonts/Baskerville.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Big Caslon';
            src: url('./fonts/BigCaslon.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Bodoni 72';
            src: url('./fonts/Bodoni 72.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Bradley Hand';
            src: url('./fonts/Bradley Hand Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Brush Script';
            src: url('./fonts/Brush Script.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Chalkboard';
            src: url('./fonts/Chalkboard.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Chalkduster';
            src: url('./fonts/Chalkduster.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Charter';
            src: url('./fonts/Charter.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Cochin';
            src: url('./fonts/Cochin.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Copperplate';
            src: url('./fonts/Copperplate.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Didot';
            src: url('./fonts/Didot.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Futura';
            src: url('./fonts/Futura.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Gill Sans';
            src: url('./fonts/GillSans.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Herculanum';
            src: url('./fonts/Herculanum.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Hoefler Text';
            src: url('./fonts/Hoefler Text.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Impact';
            src: url('./fonts/Impact.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Luminari';
            src: url('./fonts/Luminari.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Marion';
            src: url('./fonts/Marion.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Papyrus';
            src: url('./fonts/Papyrus.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Phosphate';
            src: url('./fonts/Phosphate.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Rockwell';
            src: url('./fonts/Rockwell.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Savoye LET';
            src: url('./fonts/Savoye LET.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Skia';
            src: url('./fonts/Skia.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Snell Roundhand';
            src: url('./fonts/SnellRoundhand.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Trattatello';
            src: url('./fonts/Trattatello.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Zapfino';
            src: url('./fonts/Zapfino.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        /* Web Fonts */
        @font-face {
            font-family: 'Arial';
            src: url('./fonts/Arial.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Arial Black';
            src: url('./fonts/Arial Black.ttf') format('truetype');
            font-weight: 900;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Comic Sans MS';
            src: url('./fonts/Comic Sans MS.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Courier New';
            src: url('./fonts/Courier New.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Georgia';
            src: url('./fonts/Georgia.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Tahoma';
            src: url('./fonts/Tahoma.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Times New Roman';
            src: url('./fonts/Times New Roman.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Trebuchet MS';
            src: url('./fonts/Trebuchet MS.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Verdana';
            src: url('./fonts/Verdana.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        /* Monospace Fonts */
        @font-face {
            font-family: 'Andale Mono';
            src: url('./fonts/Andale Mono.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'PT Mono';
            src: url('./fonts/PTMono.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        /* International Fonts */
        @font-face {
            font-family: 'Songti';
            src: url('./fonts/Songti.ttc') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        /* Korean Fonts - 210 Series */
        @font-face {
            font-family: '210 춘춘시대';
            src: url('./fonts/210 Chungchunsidae R.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: '210 멋진어느날';
            src: url('./fonts/210 Mutjinueonuenal R.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: '210 옴니고딕';
            src: url('./fonts/210 OmniGothic 030.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: '210 양말구멍';
            src: url('./fonts/210 Yangmalgumung R.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: '210 골목길';
            src: url('./fonts/210 골목길OTF R.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: '210 골목길';
            src: url('./fonts/210 골목길OTF L.otf') format('opentype');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: '210 골목길';
            src: url('./fonts/210 골목길OTF B.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: '210 밤의해변';
            src: url('./fonts/210 밤의해변R.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: '210 에브리바디';
            src: url('./fonts/210 에브리바디R.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: '210 에브리바디';
            src: url('./fonts/210 에브리바디L.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: '210 에브리바디';
            src: url('./fonts/210 에브리바디B.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: '210 직장인의한마디';
            src: url('./fonts/210 직장인의한마디R.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: '210 팅커벨';
            src: url('./fonts/210 팅커벨OTF R.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        /* Korean Fonts - Arita */
        @font-face {
            font-family: 'Arita Dotum';
            src: url('./fonts/AritaDotumKR-Thin.ttf') format('truetype');
            font-weight: 100;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Arita Dotum';
            src: url('./fonts/AritaDotumKR-Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Arita Dotum';
            src: url('./fonts/AritaDotumKR-Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Arita Dotum';
            src: url('./fonts/AritaDotumKR-SemiBold.ttf') format('truetype');
            font-weight: 600;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Arita Dotum';
            src: url('./fonts/AritaDotumKR-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }
        
        /* Korean Fonts - BM Fonts */
        @font-face {
            font-family: 'BM Dohyeon';
            src: url('./fonts/BMDOHYEON_ttf.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'BM Hanna';
            src: url('./fonts/BMHANNA_11yrs_ttf.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'BM Jua';
            src: url('./fonts/BMJUA_ttf.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        /* Korean Fonts - Classic */
        @font-face {
            font-family: 'Chosun Gu';
            src: url('./fonts/ChosunGu.TTF') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Chosun Nm';
            src: url('./fonts/ChosunNm.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        /* Korean Fonts - Modern */
        @font-face {
            font-family: '학교안심 지우개';
            src: url('./fonts/HakgyoansimJiugaeOTFR.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'MapleStory';
            src: url('./fonts/Maplestory Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'MapleStory';
            src: url('./fonts/Maplestory Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'OG Renaissance';
            src: url('./fonts/OG 르네상스 비밀.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'THE Playing';
            src: url('./fonts/THEPlaying.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'tvN Enjoystories';
            src: url('./fonts/tvN Enjoystories Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'tvN Enjoystories';
            src: url('./fonts/tvN Enjoystories Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'tvN Enjoystories';
            src: url('./fonts/tvN Enjoystories Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Wiggle';
            src: url('./fonts/wiggle-hangeul.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        /* Design Fonts */
        @font-face {
            font-family: 'Cafe de Paris';
            src: url('./fonts/CafeDeParisSans.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Cafe de Paris Script';
            src: url('./fonts/CafedeparisScript.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Creattion';
            src: url('./fonts/Creattion Demo.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Palladium';
            src: url('./fonts/Palladium.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Resident Evil';
            src: url('./fonts/Resident_Evil_Large.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'VITRO CORE';
            src: url('./fonts/VITRO CORE TTF.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'VITRO INSPIRE';
            src: url('./fonts/VITRO INSPIRE TTF.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'VITRO PRIDE';
            src: url('./fonts/VITRO PRIDE TTF.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Walt Disney';
            src: url('./fonts/WaltDisney Font.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f0f2f5;
            --bg-sidebar: #2c3e50;
            
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-tertiary: #adb5bd;
            --text-white: #ffffff;
            
            --border-color: #dee2e6;
            --border-light: #e9ecef;
            
            --accent-primary: #00d4ff;
            --accent-hover: #00b8e6;
            --accent-active: #0099cc;
            
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            
            --transition: all 0.2s ease;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            height: 56px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-center {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Buttons */
        .btn {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--bg-secondary);
            border-color: var(--text-secondary);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            justify-content: center;
            border-radius: var(--radius-sm);
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            height: 100vh;
            padding-top: 56px;
        }

        /* Left Icon Sidebar */
        .icon-sidebar {
            width: 56px;
            background: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 0;
            gap: 8px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .icon-btn.active {
            background: rgba(255, 255, 255, 0.15);
            color: var(--accent-primary);
        }

        .icon-btn i {
            font-size: 18px;
        }

        .icon-tooltip {
            position: absolute;
            left: 100%;
            margin-left: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .icon-btn:hover .icon-tooltip {
            opacity: 1;
        }

        /* Tool Sidebar */
        .tool-sidebar {
            width: 280px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-section {
            border-bottom: 1px solid var(--border-light);
        }

        .section-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
        }

        .section-header:hover {
            background: var(--bg-secondary);
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-toggle {
            color: var(--text-secondary);
            transition: transform 0.2s;
        }

        .section-header.collapsed .section-toggle {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 12px 16px;
            transition: max-height 0.3s ease;
            overflow: hidden;
        }

        .section-content.collapsed {
            max-height: 0;
            padding: 0 16px;
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 13px;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: white;
        }

        /* Font Family and Weight Control */
        .font-family-control {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .font-family-select {
            flex: 1;
        }

        .font-weight-select {
            width: 90px;
            font-size: 12px;
        }

        /* Text Formatting Toolbar */
        .format-toolbar {
            display: flex;
            gap: 4px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 12px;
        }

        .format-btn {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border-light);
            background: white;
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: var(--transition);
        }

        .format-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .format-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .format-separator {
            width: 1px;
            background: var(--border-light);
            margin: 0 4px;
        }

        /* Font Size Control */
        .font-size-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .font-size-input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: 14px;
            font-weight: 600;
        }

        .font-size-buttons {
            display: flex;
            gap: 2px;
        }

        .font-size-btn {
            width: 24px;
            height: 24px;
            border: 1px solid var(--border-light);
            background: white;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: var(--transition);
        }

        .font-size-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        /* Alignment Buttons */
        .alignment-group {
            display: flex;
            gap: 2px;
            margin-bottom: 12px;
        }

        .align-btn {
            flex: 1;
            height: 32px;
            border: 1px solid var(--border-light);
            background: white;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .align-btn:first-child {
            border-radius: var(--radius-sm) 0 0 var(--radius-sm);
        }

        .align-btn:last-child {
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .align-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .align-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        /* Color Picker */
        .color-group {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
        }

        .color-picker-wrapper {
            position: relative;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .color-picker {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: transparent;
        }

        .lego-color-button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .lego-color-button-small {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .lego-color-button:hover {
            transform: translateY(-1px);
        }

        .lego-color-button:active {
            transform: translateY(0);
        }
        
        .lego-color-button-small:hover {
            transform: translateY(-1px);
        }
        
        .lego-color-button-small:active {
            transform: translateY(0);
        }

        .color-code-input {
            width: 90px;
            height: 32px;
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Paperlogy', monospace;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .color-code-input-small {
            width: 65px;
            height: 24px;
            padding: 2px 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Paperlogy', monospace;
            font-size: 10px;
            transition: all 0.2s ease;
        }
        
        .color-controls-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        
        .color-control-item {
            flex: 1;
        }
        
        .form-label-small {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .color-code-input:hover {
            border-color: var(--primary);
        }

        .color-code-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }
        
        /* Table Creator Styles */
        .table-creator-container {
            padding: 10px 0;
        }
        
        .table-size-selector {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 10px;
            max-width: 220px;
            margin: 0 auto 10px;
        }
        
        .table-grid-cell {
            width: 18px;
            height: 18px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .table-grid-cell:hover,
        .table-grid-cell.highlighted {
            background: #007AFF;
            border-color: #0051D5;
        }
        
        .table-size-display {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        /* Draggable Table Styles */
        .draggable-table {
            position: absolute;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: move;
            min-width: 100px;
            min-height: 50px;
        }
        
        .draggable-table.selected {
            outline: 2px solid #007AFF;
            outline-offset: 2px;
        }
        
        .draggable-table.selected .table-spacing-handles {
            display: block !important;
        }
        
        .draggable-table td {
            border: 1px solid #ddd;
            padding: 8px;
            min-width: 80px;
            min-height: 30px;
            position: relative;
            background: white;
            cursor: cell;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }
        
        .draggable-table.selecting td {
            cursor: crosshair;
        }
        
        .draggable-table td:hover {
            background: #f8f9fa;
        }
        
        .draggable-table td.selected-cell {
            background: #e3f2fd !important;
            border-color: #2196F3;
        }
        
        .draggable-table td.selecting {
            background: #f5f5f5;
        }
        
        .draggable-table td.selection-preview {
            background: #e8f4fd;
            transition: background-color 0.1s ease;
        }
        
        .draggable-table td.editing {
            outline: 2px solid #007AFF;
            outline-offset: -2px;
            background: white;
            z-index: 10;
        }
        
        /* Table Resize Handles */
        .table-resize-handle {
            position: absolute;
            background: #007AFF;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .draggable-table.selected .table-resize-handle {
            opacity: 1;
        }
        
        .table-resize-handle:hover {
            opacity: 1 !important;
        }
        
        .table-resize-handle.right {
            right: -3px;
            top: 0;
            width: 6px;
            height: 100%;
            cursor: col-resize;
        }
        
        .table-resize-handle.bottom {
            bottom: -3px;
            left: 0;
            width: 100%;
            height: 6px;
            cursor: row-resize;
        }
        
        .table-resize-handle.corner {
            right: -3px;
            bottom: -3px;
            width: 10px;
            height: 10px;
            cursor: nwse-resize;
            background: #007AFF;
            border-radius: 2px;
        }
        
        /* Table Controls */
        .table-controls {
            position: absolute;
            top: -35px;
            right: 0;
            display: none;
            gap: 5px;
            background: white;
            padding: 4px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .draggable-table.selected .table-controls {
            display: flex;
        }
        
        .table-control-btn {
            padding: 4px 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .table-control-btn:hover {
            background: #f5f5f5;
            border-color: #007AFF;
        }

        .color-picker::-webkit-color-swatch-wrapper {
            padding: 2px;
        }

        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 2px;
        }

        /* Editor Area */
        .editor-container {
            flex: 1;
            background: var(--bg-tertiary);
            overflow-y: auto;
            padding: 24px;
            display: flex;
            justify-content: center;
        }

        .editor-wrapper {
            width: 100%;
            max-width: 816px; /* A4 width at 96 DPI */
        }

        .page {
            background: white;
            box-shadow: var(--shadow-lg);
            margin-bottom: 24px;
            padding: 40px 60px;
            min-height: 1056px; /* A4 height at 96 DPI */
            border-radius: var(--radius-sm);
            position: relative;
        }

        .page-number {
            position: absolute;
            bottom: 20px;
            right: 40px;
            color: var(--text-tertiary);
            font-size: 12px;
        }

        .editor-content {
            min-height: 900px;
            outline: none;
            font-size: 16px;
            line-height: 1.8;
            color: var(--text-primary);
            position: relative;
        }

        .editor-content h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .editor-content h2 {
            font-size: 22px;
            font-weight: 600;
            margin: 20px 0 12px;
            color: var(--text-primary);
        }

        .editor-content p {
            margin-bottom: 12px;
        }

        /* Add Page Button */
        .add-page-btn {
            width: 100%;
            padding: 32px;
            background: white;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .add-page-btn:hover {
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
        }

        .add-page-icon {
            font-size: 32px;
            color: var(--accent-primary);
        }

        /* Image Upload Area */
        .image-upload-area {
            background: var(--accent-primary);
            border: none;
            border-radius: var(--radius-md);
            padding: 10px 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 212, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .image-upload-area:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }

        .image-upload-area:active {
            transform: translateY(0);
        }

        .image-upload-area.dragover {
            background: var(--accent-active);
            box-shadow: 0 4px 16px rgba(0, 212, 255, 0.4);
        }

        .upload-icon {
            font-size: 28px;
            color: white;
            margin-bottom: 6px;
        }

        .upload-text {
            font-size: 14px;
            color: white;
            font-weight: 500;
        }

        /* Image Gallery */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 16px;
            max-height: 400px;
            overflow-y: auto;
            padding: 4px;
        }

        .gallery-item {
            position: relative;
            aspect-ratio: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            overflow: hidden;
            cursor: grab;
            transition: var(--transition);
        }

        .gallery-item:hover {
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }

        .gallery-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .gallery-item:hover .delete-btn {
            opacity: 1;
        }

        /* Image Container */
        .image-container {
            position: absolute;
            display: inline-block;
            margin: 0;
            border-radius: var(--radius-sm);
            overflow: visible;
            user-select: none;
            cursor: move;
            z-index: 1;
        }
        
        .image-container.dragging {
            opacity: 0.8;
            z-index: 1000;
        }

        .image-container:hover .image-controls,
        .image-container.selected .image-controls {
            opacity: 1;
        }

        .image-container.selected {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        .inserted-image {
            width: 100%;
            height: auto;
            display: block;
            cursor: move;
            pointer-events: none;
        }

        /* Image Resize Handles */
        .resize-handles {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            pointer-events: none;
        }

        .image-container.selected .resize-handles {
            display: block;
        }

        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--accent-primary);
            border: 2px solid white;
            border-radius: 50%;
            pointer-events: all;
            cursor: nwse-resize;
        }

        .resize-handle.top-left {
            top: -5px;
            left: -5px;
            cursor: nw-resize;
        }

        .resize-handle.top-right {
            top: -5px;
            right: -5px;
            cursor: ne-resize;
        }

        .resize-handle.bottom-left {
            bottom: -5px;
            left: -5px;
            cursor: sw-resize;
        }

        .resize-handle.bottom-right {
            bottom: -5px;
            right: -5px;
            cursor: se-resize;
        }

        .resize-handle.top {
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            cursor: n-resize;
        }

        .resize-handle.right {
            top: 50%;
            right: -5px;
            transform: translateY(-50%);
            cursor: e-resize;
        }

        .resize-handle.bottom {
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            cursor: s-resize;
        }

        .resize-handle.left {
            top: 50%;
            left: -5px;
            transform: translateY(-50%);
            cursor: w-resize;
        }

        .image-controls {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            background: rgba(0, 0, 0, 0.8);
            padding: 4px;
            border-radius: var(--radius-sm);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .image-control-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: var(--transition);
        }

        .image-control-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        /* Rotation Handle */
        .rotation-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            border: 2px solid white;
            border-radius: 50%;
            cursor: grab;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            z-index: 10;
        }
        
        .rotation-handle::before {
            content: '';
            position: absolute;
            width: 2px;
            height: 20px;
            background: var(--accent-primary);
            top: 18px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .shape-element.selected .rotation-handle {
            display: block;
        }
        
        .rotation-handle:active {
            cursor: grabbing;
        }
        
        /* Shape Panel Styles */
        .shape-categories {
            display: flex;
            gap: 0;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .shape-category-tab {
            flex: 1;
            padding: 8px 4px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }
        
        .shape-category-tab:hover {
            color: var(--text-primary);
        }
        
        .shape-category-tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }
        
        .shape-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .shape-item {
            aspect-ratio: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .shape-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .shape-item svg {
            width: 60%;
            height: 60%;
            fill: var(--text-secondary);
            stroke: var(--text-secondary);
            transition: var(--transition);
        }
        
        .shape-item:hover svg {
            fill: var(--accent-primary);
            stroke: var(--accent-primary);
        }
        
        .shape-item .shape-label {
            position: absolute;
            bottom: 4px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 10px;
            color: var(--text-tertiary);
        }
        
        /* Shape in Editor */
        .shape-element {
            position: absolute;
            cursor: move;
            user-select: none;
        }
        
        .shape-element.selected {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        .shape-element.dragging {
            opacity: 0.8;
            z-index: 1000;
            cursor: grabbing !important;
        }
        
        .shape-element:hover .image-controls,
        .shape-element.selected .image-controls {
            opacity: 1;
        }
        
        .shape-element .resize-handles {
            display: none;
        }
        
        .shape-element.selected .resize-handles {
            display: block;
        }
        
        .shape-element svg {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .shape-element {
            transform-origin: center center;
        }
        
        /* Prevent shape squishing for lines */
        .shape-element[data-shape-type*="line"] {
            height: 20px !important;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.3s ease;
            z-index: 2000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .tool-sidebar {
                position: absolute;
                left: 56px;
                height: calc(100vh - 56px);
                z-index: 100;
                box-shadow: var(--shadow-lg);
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .tool-sidebar.open {
                transform: translateX(0);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* File Input Hidden */
        .file-input {
            display: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <i class="fas fa-book"></i>
                <span>전자책 에디터</span>
            </div>
        </div>
        <div class="header-center">
            <input type="text" class="form-control" style="max-width: 300px;" placeholder="제목 없는 문서" id="documentTitle">
        </div>
        <div class="header-right">
            <button class="btn btn-sm" onclick="saveDocument()">
                <i class="fas fa-save"></i>
                저장
            </button>
            <button class="btn btn-sm" onclick="openDocument()">
                <i class="fas fa-folder-open"></i>
                열기
            </button>
            <button class="btn btn-primary btn-sm" onclick="exportToPDF()">
                <i class="fas fa-file-pdf"></i>
                PDF 내보내기
            </button>
        </div>
    </header>

    <div class="app-container">
        <!-- Left Icon Sidebar -->
        <div class="icon-sidebar">
            <button class="icon-btn active" onclick="showPanel('text')" title="텍스트">
                <i class="fas fa-font"></i>
                <span class="icon-tooltip">텍스트</span>
            </button>
            <button class="icon-btn" onclick="showPanel('upload')" title="업로드">
                <i class="fas fa-upload"></i>
                <span class="icon-tooltip">업로드</span>
            </button>
            <button class="icon-btn" onclick="showPanel('elements')" title="요소">
                <i class="fas fa-shapes"></i>
                <span class="icon-tooltip">요소</span>
            </button>
            <button class="icon-btn" onclick="showPanel('pages')" title="페이지">
                <i class="fas fa-file-alt"></i>
                <span class="icon-tooltip">페이지</span>
            </button>
        </div>

        <!-- Tool Sidebar -->
        <div class="tool-sidebar" id="toolSidebar">
            <div class="sidebar-header">텍스트</div>
            
            <!-- Text Panel -->
            <div id="textPanel" class="panel">
                <!-- 텍스트 서식 섹션 -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span class="section-title">텍스트 서식</span>
                        <i class="fas fa-chevron-down section-toggle"></i>
                    </div>
                    <div class="section-content">
                        <!-- Format Toolbar -->
                        <div class="format-toolbar">
                            <button class="format-btn" onclick="toggleFormat('bold')" title="굵게">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button class="format-btn" onclick="toggleFormat('italic')" title="기울임">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button class="format-btn" onclick="toggleFormat('underline')" title="밑줄">
                                <i class="fas fa-underline"></i>
                            </button>
                            <div class="format-separator"></div>
                            <button class="format-btn" onclick="insertList('ul')" title="글머리 기호">
                                <i class="fas fa-list-ul"></i>
                            </button>
                            <button class="format-btn" onclick="insertList('ol')" title="번호 매기기">
                                <i class="fas fa-list-ol"></i>
                            </button>
                            <div class="format-separator"></div>
                            <button class="format-btn" onclick="openEmojiPicker()" title="이모티콘">
                                <i class="fas fa-smile"></i>
                            </button>
                        </div>

                        <!-- Font Family -->
                        <div class="form-group">
                            <label class="form-label">글꼴</label>
                            <div class="font-family-control">
                                <select class="form-control font-family-select" id="fontFamily" onchange="updateFontFamily(this.value)">
                                <optgroup label="추천 글꼴">
                                    <option value="'Paperlogy', sans-serif">Paperlogy (페이퍼로지)</option>
                                    <option value="'Apple Gothic', sans-serif">Apple Gothic (애플 고딕)</option>
                                    <option value="'Apple Myungjo', serif">Apple Myungjo (애플 명조)</option>
                                    <option value="'Noto Sans KR', sans-serif">Noto Sans KR (노토 산스)</option>
                                    <option value="'Malgun Gothic', sans-serif">Malgun Gothic (맑은 고딕)</option>
                                    <option value="'Arita Dotum', sans-serif">Arita Dotum (아리따 돋움)</option>
                                </optgroup>
                                <optgroup label="나눔 글꼴">
                                    <option value="'Nanum Gothic', sans-serif">Nanum Gothic (나눔고딕)</option>
                                    <option value="'Nanum Myeongjo', serif">Nanum Myeongjo (나눔명조)</option>
                                </optgroup>
                                <optgroup label="제목용 글꼴">
                                    <option value="'Black Han Sans', sans-serif">Black Han Sans (검은고딕)</option>
                                    <option value="'Jua', sans-serif">Jua (주아)</option>
                                    <option value="'Do Hyeon', sans-serif">Do Hyeon (도현)</option>
                                    <option value="'BM Dohyeon', sans-serif">BM Dohyeon (배민 도현)</option>
                                    <option value="'BM Hanna', sans-serif">BM Hanna 11yrs (배민 한나 11살)</option>
                                    <option value="'BM Jua', sans-serif">BM Jua (배민 주아)</option>
                                    <option value="'Impact', sans-serif">Impact (임팩트)</option>
                                    <option value="'Phosphate', sans-serif">Phosphate (포스페이트)</option>
                                    <option value="'Chalkduster', cursive">Chalkduster (초크더스터)</option>
                                    <option value="'tvN Enjoystories', sans-serif">tvN Enjoystories (tvN 즐거운이야기)</option>
                                    <option value="'OG Renaissance', sans-serif">OG Renaissance Secret (OG 르네상스 비밀)</option>
                                </optgroup>
                                <optgroup label="본문용 글꼴">
                                    <option value="'Gowun Dodum', sans-serif">Gowun Dodum (고운돋움)</option>
                                    <option value="'Gowun Batang', serif">Gowun Batang (고운바탕)</option>
                                    <option value="'Chosun Gu', serif">Chosun Gu (조선일보 굴림)</option>
                                    <option value="'Chosun Nm', serif">Chosun Nm (조선일보 명조)</option>
                                    <option value="'Georgia', serif">Georgia (조지아)</option>
                                    <option value="'Times New Roman', serif">Times New Roman (타임즈 뉴 로만)</option>
                                    <option value="'Baskerville', serif">Baskerville (바스커빌)</option>
                                    <option value="'Charter', serif">Charter (차터)</option>
                                    <option value="'Hoefler Text', serif">Hoefler Text (회플러 텍스트)</option>
                                </optgroup>
                                <optgroup label="고딕 & 산세리프">
                                    <option value="'Arial', sans-serif">Arial (에어리얼)</option>
                                    <option value="'Arial Black', sans-serif">Arial Black (에어리얼 블랙)</option>
                                    <option value="'Verdana', sans-serif">Verdana (버다나)</option>
                                    <option value="'Tahoma', sans-serif">Tahoma (타호마)</option>
                                    <option value="'Trebuchet MS', sans-serif">Trebuchet MS (트레부셰 MS)</option>
                                    <option value="'Gill Sans', sans-serif">Gill Sans (길 산스)</option>
                                    <option value="'Futura', sans-serif">Futura (푸투라)</option>
                                </optgroup>
                                <optgroup label="명조 & 세리프">
                                    <option value="'Bodoni 72', serif">Bodoni 72 (보도니 72)</option>
                                    <option value="'Big Caslon', serif">Big Caslon (빅 캐슬론)</option>
                                    <option value="'Cochin', serif">Cochin (코친)</option>
                                    <option value="'Didot', serif">Didot (디도)</option>
                                    <option value="'Marion', serif">Marion (마리온)</option>
                                    <option value="'Rockwell', serif">Rockwell (록웰)</option>
                                </optgroup>
                                <optgroup label="필기체 & 캘리그래피">
                                    <option value="'Brush Script', cursive">Brush Script MT (브러시 스크립트)</option>
                                    <option value="'Bradley Hand', cursive">Bradley Hand (브래들리 핸드)</option>
                                    <option value="'Chalkboard', cursive">Chalkboard (초크보드)</option>
                                    <option value="'Comic Sans MS', cursive">Comic Sans MS (코믹 산스)</option>
                                    <option value="'Luminari', fantasy">Luminari (루미나리)</option>
                                    <option value="'Papyrus', fantasy">Papyrus (파피루스)</option>
                                    <option value="'Savoye LET', cursive">Savoye LET (사보이)</option>
                                    <option value="'Snell Roundhand', cursive">Snell Roundhand (스넬 라운드핸드)</option>
                                    <option value="'Trattatello', cursive">Trattatello (트라타텔로)</option>
                                    <option value="'Zapfino', cursive">Zapfino (자피노)</option>
                                </optgroup>
                                <optgroup label="고정폭 글꼴">
                                    <option value="'Courier New', monospace">Courier New (쿠리어 뉴)</option>
                                    <option value="'Andale Mono', monospace">Andale Mono (안달레 모노)</option>
                                    <option value="'PT Mono', monospace">PT Mono (PT 모노)</option>
                                </optgroup>
                                <optgroup label="장식용 글꼴">
                                    <option value="'American Typewriter', serif">American Typewriter (아메리칸 타이프라이터)</option>
                                    <option value="'Copperplate', serif">Copperplate (카퍼플레이트)</option>
                                    <option value="'Herculanum', fantasy">Herculanum (헤르쿨라눔)</option>
                                    <option value="'Skia', sans-serif">Skia (스키아)</option>
                                </optgroup>
                                <optgroup label="국제 글꼴">
                                    <option value="'Songti', serif">Songti SC (송티)</option>
                                    <option value="'Sunflower', sans-serif">Sunflower (해바라기)</option>
                                </optgroup>
                                <optgroup label="캐주얼 글꼴">
                                    <option value="'Poor Story', sans-serif">Poor Story (가난한이야기)</option>
                                    <option value="'Stylish', sans-serif">Stylish (스타일리시)</option>
                                    <option value="'Single Day', sans-serif">Single Day (싱글데이)</option>
                                    <option value="'Hi Melody', sans-serif">Hi Melody (하이멜로디)</option>
                                    <option value="'Cute Font', sans-serif">Cute Font (귀여운 글꼴)</option>
                                    <option value="'Gaegu', sans-serif">Gaegu (개구)</option>
                                    <option value="'MapleStory', sans-serif">MapleStory (메이플스토리)</option>
                                    <option value="'학교안심 지우개', cursive">Hakgyoansim Jiugae (학교안심 지우개)</option>
                                    <option value="'THE Playing', sans-serif">THE Playing (더 플레잉)</option>
                                    <option value="'Wiggle', cursive">Wiggle (위글)</option>
                                </optgroup>
                                <optgroup label="210 시리즈">
                                    <option value="'210 춘춘시대', sans-serif">210 Chunchun Sidae (210 춘춘시대)</option>
                                    <option value="'210 멋진어느날', sans-serif">210 Nice Day (210 멋진어느날)</option>
                                    <option value="'210 옴니고딕', sans-serif">210 OmniGothic (210 옴니고딕)</option>
                                    <option value="'210 양말구멍', sans-serif">210 Yangmal Gumung (210 양말구멍)</option>
                                    <option value="'210 골목길', sans-serif">210 Golmokgil (210 골목길)</option>
                                    <option value="'210 밤의해변', sans-serif">210 Night Beach (210 밤의해변)</option>
                                    <option value="'210 에브리바디', sans-serif">210 Everybody (210 에브리바디)</option>
                                    <option value="'210 직장인의한마디', sans-serif">210 Office Worker (210 직장인의한마디)</option>
                                    <option value="'210 팅커벨', cursive">210 Tinkerbell (210 팅커벨)</option>
                                </optgroup>
                                <optgroup label="특수 효과 글꼴">
                                    <option value="'Cafe de Paris', sans-serif">Cafe de Paris (카페 드 파리)</option>
                                    <option value="'Cafe de Paris Script', cursive">Cafe de Paris Script (카페 드 파리 스크립트)</option>
                                    <option value="'Creattion', cursive">Creattion (크리에이션)</option>
                                    <option value="'Palladium', sans-serif">Palladium (팔라디움)</option>
                                    <option value="'Resident Evil', fantasy">Resident Evil (레지던트 이블)</option>
                                    <option value="'VITRO CORE', sans-serif">VITRO CORE (비트로 코어)</option>
                                    <option value="'VITRO INSPIRE', sans-serif">VITRO INSPIRE (비트로 인스파이어)</option>
                                    <option value="'VITRO PRIDE', sans-serif">VITRO PRIDE (비트로 프라이드)</option>
                                    <option value="'Walt Disney', fantasy">Walt Disney (월트 디즈니)</option>
                                </optgroup>
                                </select>
                                <select class="form-control font-weight-select" id="fontWeight" onchange="applyFormat('fontWeight', this.value)">
                                    <option value="100">Thin</option>
                                    <option value="200">ExtraLight</option>
                                    <option value="300">Light</option>
                                    <option value="400" selected>Regular</option>
                                    <option value="500">Medium</option>
                                    <option value="600">SemiBold</option>
                                    <option value="700">Bold</option>
                                    <option value="800">ExtraBold</option>
                                    <option value="900">Black</option>
                                </select>
                            </div>
                        </div>

                        <!-- Font Size -->
                        <div class="font-size-control">
                            <input type="number" class="font-size-input" id="fontSize" value="16" min="8" max="144" 
                                   onchange="applyFormat('fontSize', this.value + 'px')">
                            <div class="font-size-buttons">
                                <button class="font-size-btn" onclick="changeFontSize(-1)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button class="font-size-btn" onclick="changeFontSize(1)">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Text Alignment -->
                        <div class="alignment-group">
                            <button class="align-btn active" onclick="setAlignment('left')" title="왼쪽 정렬">
                                <i class="fas fa-align-left"></i>
                            </button>
                            <button class="align-btn" onclick="setAlignment('center')" title="가운데 정렬">
                                <i class="fas fa-align-center"></i>
                            </button>
                            <button class="align-btn" onclick="setAlignment('right')" title="오른쪽 정렬">
                                <i class="fas fa-align-right"></i>
                            </button>
                            <button class="align-btn" onclick="setAlignment('justify')" title="양쪽 정렬">
                                <i class="fas fa-align-justify"></i>
                            </button>
                        </div>

                        <!-- Text and Background Colors -->
                        <div class="color-controls-row">
                            <div class="color-control-item">
                                <label class="form-label-small">글자</label>
                                <div class="color-picker-wrapper">
                                    <button id="textColorButton" class="lego-color-button-small" 
                                            onclick="openTextColorPicker()"
                                            style="background: #212529; 
                                                   box-shadow: 0 1px 0 0 #191c1f, 0 1px 0 0 #0f1113, 0 1px 2px rgba(0,0,0,0.2);">
                                        🎨
                                    </button>
                                    <input type="hidden" id="textColor" value="#212529">
                                    <input type="text" class="color-code-input-small" id="textColorCode" value="#212529" 
                                           placeholder="#000000"
                                           onchange="updateColorFromCode('text', this.value)">
                                </div>
                            </div>
                            <div class="color-control-item">
                                <label class="form-label-small">배경</label>
                                <div class="color-picker-wrapper">
                                    <button id="bgColorButton" class="lego-color-button-small" 
                                            onclick="openBgColorPicker()"
                                            style="background: #FFFFFF; 
                                                   box-shadow: 0 1px 0 0 #e0e0e0, 0 1px 0 0 #cccccc, 0 1px 2px rgba(0,0,0,0.2);
                                                   border: 1px solid #ddd;">
                                        🎨
                                    </button>
                                    <input type="hidden" id="bgColor" value="#FFFFFF">
                                    <input type="text" class="color-code-input-small" id="bgColorCode" value="#FFFFFF" 
                                           placeholder="#FFFFFF"
                                           onchange="updateColorFromCode('bg', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 표 만들기 섹션 -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span class="section-title">표 만들기</span>
                        <i class="fas fa-chevron-down section-toggle"></i>
                    </div>
                    <div class="section-content">
                        <div class="table-creator-container">
                            <div class="table-size-selector" id="tableSizeSelector">
                                <!-- Table grid will be generated here -->
                            </div>
                            <div class="table-size-display" id="tableSizeDisplay">0 × 0</div>
                            <button class="btn btn-primary" onclick="createTable()" style="width: 100%; margin-top: 10px;">
                                <i class="fas fa-table"></i> 표 삽입
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 줄 간격 섹션 -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span class="section-title">줄 간격</span>
                        <i class="fas fa-chevron-down section-toggle"></i>
                    </div>
                    <div class="section-content">
                        <select class="form-control" onchange="applyFormat('lineHeight', this.value)">
                            <option value="1.2">1.2</option>
                            <option value="1.5">1.5</option>
                            <option value="1.8" selected>1.8</option>
                            <option value="2.0">2.0</option>
                            <option value="2.5">2.5</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Upload Panel -->
            <div id="uploadPanel" class="panel" style="display: none;">
                <div class="sidebar-section">
                    <div class="section-header">
                        <span class="section-title">이미지 업로드</span>
                    </div>
                    <div class="section-content">
                        <div class="image-upload-area" onclick="document.getElementById('imageInput').click()"
                             ondrop="handleDropToGallery(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <i class="fas fa-camera" style="color: white; font-size: 16px;"></i>
                            <span style="color: white; font-size: 14px; font-weight: 500;">업로드</span>
                        </div>
                        <input type="file" id="imageInput" class="file-input" accept="image/*" multiple onchange="uploadImages(this)">
                        <p style="font-size: 11px; color: var(--text-tertiary); text-align: center; margin-top: 8px; margin-bottom: 0;">
                            - 이미지를 두번클릭시 본문반영
                        </p>
                        
                        <!-- Image Gallery -->
                        <div class="image-gallery" id="imageGallery">
                            <!-- Gallery items will be added here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Elements Panel -->
            <div id="elementsPanel" class="panel" style="display: none;">
                <div class="sidebar-section">
                    <div class="section-header">
                        <span class="section-title">도형</span>
                    </div>
                    <div class="section-content">
                        <!-- Shape Categories -->
                        <div class="shape-categories">
                            <button class="shape-category-tab active" onclick="showShapeCategory('basic')">기본</button>
                            <button class="shape-category-tab" onclick="showShapeCategory('bubble')">말풍선</button>
                            <button class="shape-category-tab" onclick="showShapeCategory('line')">선</button>
                            <button class="shape-category-tab" onclick="showShapeCategory('icon')">아이콘</button>
                        </div>
                        
                        <!-- Basic Shapes -->
                        <div id="basicShapes" class="shape-grid">
                            <div class="shape-item" onclick="addShape('rectangle')">
                                <svg viewBox="0 0 100 100">
                                    <rect x="20" y="20" width="60" height="60" fill="currentColor" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('circle')">
                                <svg viewBox="0 0 100 100">
                                    <circle cx="50" cy="50" r="30" fill="currentColor" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('triangle')">
                                <svg viewBox="0 0 100 100">
                                    <polygon points="50,20 80,70 20,70" fill="currentColor" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('diamond')">
                                <svg viewBox="0 0 100 100">
                                    <polygon points="50,20 80,50 50,80 20,50" fill="currentColor" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('star')">
                                <svg viewBox="0 0 100 100">
                                    <polygon points="50,15 61,35 82,35 67,50 73,71 50,59 27,71 33,50 18,35 39,35" fill="currentColor" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('heart')">
                                <svg viewBox="0 0 100 100">
                                    <path d="M50,25 C30,0 0,10 25,40 L50,70 L75,40 C100,10 70,0 50,25 Z" fill="currentColor" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('hexagon')">
                                <svg viewBox="0 0 100 100">
                                    <polygon points="50,10 80,25 80,55 50,70 20,55 20,25" fill="currentColor" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('octagon')">
                                <svg viewBox="0 0 100 100">
                                    <polygon points="35,15 65,15 85,35 85,65 65,85 35,85 15,65 15,35" fill="currentColor" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('arrow-right')">
                                <svg viewBox="0 0 100 100">
                                    <polygon points="20,35 60,35 60,20 80,50 60,80 60,65 20,65" fill="currentColor" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('donut')">
                                <svg viewBox="0 0 100 100">
                                    <path d="M50,20 A30,30 0 1,1 49.9,20 Z M50,35 A15,15 0 1,0 50.1,35 Z" fill-rule="evenodd" fill="currentColor" />
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Bubble Shapes (Hidden by default) -->
                        <div id="bubbleShapes" class="shape-grid" style="display: none;">
                            <div class="shape-item" onclick="addShape('speech-bubble')">
                                <svg viewBox="0 0 100 100">
                                    <path d="M20,20 Q20,10 30,10 L70,10 Q80,10 80,20 L80,50 Q80,60 70,60 L40,60 L30,75 L30,60 L30,60 Q20,60 20,50 Z" fill="currentColor" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('thought-bubble')">
                                <svg viewBox="0 0 100 100">
                                    <ellipse cx="50" cy="40" rx="35" ry="25" fill="currentColor" />
                                    <circle cx="30" cy="65" r="8" fill="currentColor" />
                                    <circle cx="20" cy="75" r="5" fill="currentColor" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('banner')">
                                <svg viewBox="0 0 100 100">
                                    <path d="M10,30 L90,30 L90,60 L80,50 L90,60 L10,60 L20,50 L10,60 Z" fill="currentColor" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('ribbon')">
                                <svg viewBox="0 0 100 100">
                                    <path d="M20,40 L80,40 L85,50 L80,60 L20,60 L15,50 Z" fill="currentColor" />
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Line Shapes (Hidden by default) -->
                        <div id="lineShapes" class="shape-grid" style="display: none;">
                            <div class="shape-item" onclick="addShape('line-straight')">
                                <svg viewBox="0 0 100 100">
                                    <line x1="20" y1="50" x2="80" y2="50" stroke="currentColor" stroke-width="3" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('line-dashed')">
                                <svg viewBox="0 0 100 100">
                                    <line x1="20" y1="50" x2="80" y2="50" stroke="currentColor" stroke-width="3" stroke-dasharray="5,5" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('line-dotted')">
                                <svg viewBox="0 0 100 100">
                                    <line x1="20" y1="50" x2="80" y2="50" stroke="currentColor" stroke-width="3" stroke-dasharray="1,4" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('arrow-line')">
                                <svg viewBox="0 0 100 100">
                                    <defs>
                                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="currentColor" />
                                        </marker>
                                    </defs>
                                    <line x1="20" y1="50" x2="80" y2="50" stroke="currentColor" stroke-width="3" marker-end="url(#arrowhead)" />
                                </svg>
                            </div>
                            <div class="shape-item" onclick="addShape('arrow-double')">
                                <svg viewBox="0 0 100 100">
                                    <defs>
                                        <marker id="arrowhead2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="currentColor" />
                                        </marker>
                                        <marker id="arrowhead3" markerWidth="10" markerHeight="7" refX="1" refY="3.5" orient="auto">
                                            <polygon points="10 0, 0 3.5, 10 7" fill="currentColor" />
                                        </marker>
                                    </defs>
                                    <line x1="20" y1="50" x2="80" y2="50" stroke="currentColor" stroke-width="3" marker-start="url(#arrowhead3)" marker-end="url(#arrowhead2)" />
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Icon Shapes (Hidden by default) -->
                        <div id="iconShapes" class="shape-grid" style="display: none;">
                            <div class="shape-item" onclick="addShape('icon-check')">
                                <i class="fas fa-check" style="font-size: 24px; color: var(--text-secondary);"></i>
                            </div>
                            <div class="shape-item" onclick="addShape('icon-heart')">
                                <i class="fas fa-heart" style="font-size: 24px; color: var(--text-secondary);"></i>
                            </div>
                            <div class="shape-item" onclick="addShape('icon-star')">
                                <i class="fas fa-star" style="font-size: 24px; color: var(--text-secondary);"></i>
                            </div>
                            <div class="shape-item" onclick="addShape('icon-bulb')">
                                <i class="fas fa-lightbulb" style="font-size: 24px; color: var(--text-secondary);"></i>
                            </div>
                            <div class="shape-item" onclick="addShape('icon-home')">
                                <i class="fas fa-home" style="font-size: 24px; color: var(--text-secondary);"></i>
                            </div>
                            <div class="shape-item" onclick="addShape('icon-user')">
                                <i class="fas fa-user" style="font-size: 24px; color: var(--text-secondary);"></i>
                            </div>
                            <div class="shape-item" onclick="addShape('icon-search')">
                                <i class="fas fa-search" style="font-size: 24px; color: var(--text-secondary);"></i>
                            </div>
                            <div class="shape-item" onclick="addShape('icon-comment')">
                                <i class="fas fa-comment" style="font-size: 24px; color: var(--text-secondary);"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pages Panel -->
            <div id="pagesPanel" class="panel" style="display: none;">
                <div class="sidebar-section">
                    <div class="section-header">
                        <span class="section-title">페이지 관리</span>
                    </div>
                    <div class="section-content">
                        <button class="btn btn-primary" style="width: 100%;" onclick="addPage()">
                            <i class="fas fa-plus"></i>
                            새 페이지 추가
                        </button>
                    </div>
                </div>
                
                <!-- 페이지 여백 설정 -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span class="section-title">페이지 여백</span>
                        <i class="fas fa-chevron-down section-toggle"></i>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label class="form-label">여백 프리셋</label>
                            <select class="form-control" onchange="setPageMargin(this.value)">
                                <option value="normal">보통 (60px)</option>
                                <option value="narrow">좁게 (30px)</option>
                                <option value="none">여백 없음 (0px)</option>
                                <option value="wide">넓게 (80px)</option>
                                <option value="custom">사용자 지정</option>
                            </select>
                        </div>
                        
                        <div id="customMarginControls" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">상하 여백 (px)</label>
                                <input type="range" class="form-control" id="marginVertical" 
                                       min="0" max="100" value="40" 
                                       oninput="updateCustomMargin()">
                                <span id="marginVerticalValue">40px</span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">좌우 여백 (px)</label>
                                <input type="range" class="form-control" id="marginHorizontal" 
                                       min="0" max="100" value="60" 
                                       oninput="updateCustomMargin()">
                                <span id="marginHorizontalValue">60px</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Editor -->
        <main class="editor-container">
            <div class="editor-wrapper">
                <div class="page" id="page1">
                    <div class="editor-content" contenteditable="true" 
                         onpaste="handlePaste(event)" 
                         ondrop="handleDrop(event)" 
                         ondragover="handleDragOver(event)"
                         ondragenter="handleDragEnter(event)"
                         oninput="updateContent()">
                        <h1>제목을 입력해주세요.</h1>
                        <p>여기에 내용을 작성하세요.</p>
                    </div>
                    <div class="page-number">1</div>
                </div>
                
                <button class="add-page-btn" onclick="addPage()">
                    <div class="add-page-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <div>새 페이지 추가</div>
                </button>
            </div>
        </main>
    </div>

    <input type="file" id="fileInput" class="file-input" accept=".json" onchange="loadDocument(this)">

    <script>
        let currentDocument = {
            title: '제목 없는 문서',
            pages: [],
            settings: {
                fontFamily: "'Noto Sans KR', sans-serif",
                fontSize: '16px',
                lineHeight: '1.8'
            }
        };

        let pageCounter = 1;
        let selectedImage = null;
        let currentPanel = 'text';
        let uploadedImages = [];
        let resizing = false;
        let resizeData = null;

        // Initialize
        function initDocument() {
            updatePageNumbers();
            setupEventListeners();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Color picker
            document.getElementById('textColor').addEventListener('input', function() {
                // Color value is now shown in textColorCode input
                document.getElementById('textColorCode').value = this.value;
            });

            // Document title
            document.getElementById('documentTitle').addEventListener('input', function() {
                currentDocument.title = this.value || '제목 없는 문서';
            });

            // Click outside to deselect images
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.image-container') && !e.target.closest('.resize-handle')) {
                    document.querySelectorAll('.image-container').forEach(container => {
                        container.classList.remove('selected');
                    });
                    selectedImage = null;
                }
            });

            // Prevent text selection while resizing
            document.addEventListener('selectstart', function(e) {
                if (resizing) {
                    e.preventDefault();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            saveDocument();
                            break;
                        case 'o':
                            e.preventDefault();
                            openDocument();
                            break;
                        case 'b':
                            e.preventDefault();
                            toggleFormat('bold');
                            break;
                        case 'i':
                            e.preventDefault();
                            toggleFormat('italic');
                            break;
                        case 'u':
                            e.preventDefault();
                            toggleFormat('underline');
                            break;
                        case 'c':
                            // 도형이 선택된 경우 복사
                            if (selectedShape && !window.getSelection().toString()) {
                                e.preventDefault();
                                copiedShape = selectedShape.cloneNode(true);
                                showToast('도형이 복사되었습니다');
                            }
                            break;
                        case 'v':
                            // 복사된 도형이 있는 경우 붙여넣기
                            if (copiedShape && !window.getSelection().toString()) {
                                e.preventDefault();
                                pasteShape();
                            }
                            break;
                    }
                }
                
                // Delete 키로 도형 삭제
                if (e.key === 'Delete' && selectedShape) {
                    selectedShape.remove();
                    selectedShape = null;
                    showToast('도형이 삭제되었습니다');
                }
            });
        }

        // Show panel
        function showPanel(panelName) {
            // Update active button
            document.querySelectorAll('.icon-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.icon-btn').classList.add('active');

            // Hide all panels
            document.querySelectorAll('.panel').forEach(panel => {
                panel.style.display = 'none';
            });

            // Show selected panel
            document.getElementById(panelName + 'Panel').style.display = 'block';

            // Update sidebar header
            const titles = {
                text: '텍스트',
                upload: '업로드',
                elements: '요소',
                pages: '페이지'
            };
            document.querySelector('.sidebar-header').textContent = titles[panelName];

            // Show sidebar on mobile
            if (window.innerWidth <= 1024) {
                document.getElementById('toolSidebar').classList.add('open');
            }
        }

        // Toggle section
        function toggleSection(header) {
            header.classList.toggle('collapsed');
            const content = header.nextElementSibling;
            content.classList.toggle('collapsed');
        }

        // Apply format
        function applyFormat(property, value) {
            // Font family의 경우
            if (property === 'fontFamily') {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    
                    // 선택된 텍스트가 있는 경우
                    if (!range.collapsed) {
                        // 선택된 컨텐츠를 span으로 감싸서 폰트 적용
                        const selectedContent = range.extractContents();
                        const span = document.createElement('span');
                        span.style.fontFamily = value;
                        span.appendChild(selectedContent);
                        range.insertNode(span);
                        
                        // 선택 영역 복원
                        selection.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.selectNodeContents(span);
                        selection.addRange(newRange);
                    } else {
                        // 선택된 텍스트가 없는 경우 - 새로 입력될 텍스트에 적용
                        // 임시 span 생성
                        const span = document.createElement('span');
                        span.style.fontFamily = value;
                        span.innerHTML = '&#8203;'; // Zero-width space
                        range.insertNode(span);
                        
                        // 커서를 span 안으로 이동
                        const newRange = document.createRange();
                        newRange.setStart(span, 0);
                        newRange.setEnd(span, 0);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    }
                }
            } 
            // Font size의 경우
            else if (property === 'fontSize') {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    
                    // 선택된 텍스트가 있는 경우
                    if (!range.collapsed) {
                        // 선택된 컨텐츠를 span으로 감싸서 폰트 크기 적용
                        const selectedContent = range.extractContents();
                        const span = document.createElement('span');
                        span.style.fontSize = value;
                        span.appendChild(selectedContent);
                        range.insertNode(span);
                        
                        // 선택 영역 복원
                        selection.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.selectNodeContents(span);
                        selection.addRange(newRange);
                    } else {
                        // 선택된 텍스트가 없는 경우 - 새로 입력될 텍스트에 적용
                        // 임시 span 생성
                        const span = document.createElement('span');
                        span.style.fontSize = value;
                        span.innerHTML = '&#8203;'; // Zero-width space
                        range.insertNode(span);
                        
                        // 커서를 span 안으로 이동
                        const newRange = document.createRange();
                        newRange.setStart(span, 0);
                        newRange.setEnd(span, 0);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    }
                }
            }
            // Color의 경우
            else if (property === 'color') {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    
                    // 선택된 텍스트가 있는 경우
                    if (!range.collapsed) {
                        // 선택된 컨텐츠를 span으로 감싸서 색상 적용
                        const selectedContent = range.extractContents();
                        const span = document.createElement('span');
                        span.style.color = value;
                        span.appendChild(selectedContent);
                        range.insertNode(span);
                        
                        // 선택 영역 복원
                        selection.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.selectNodeContents(span);
                        selection.addRange(newRange);
                    } else {
                        // 선택된 텍스트가 없는 경우 - 새로 입력될 텍스트에 적용
                        // 임시 span 생성
                        const span = document.createElement('span');
                        span.style.color = value;
                        span.innerHTML = '&#8203;'; // Zero-width space
                        range.insertNode(span);
                        
                        // 커서를 span 안으로 이동
                        const newRange = document.createRange();
                        newRange.setStart(span, 0);
                        newRange.setEnd(span, 0);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    }
                }
            }
            // Font weight의 경우
            else if (property === 'fontWeight') {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    
                    // 선택된 텍스트가 있는 경우
                    if (!range.collapsed) {
                        // 선택된 컨텐츠를 span으로 감싸서 font weight 적용
                        const selectedContent = range.extractContents();
                        const span = document.createElement('span');
                        span.style.fontWeight = value;
                        span.appendChild(selectedContent);
                        range.insertNode(span);
                        
                        // 선택 영역 복원
                        selection.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.selectNodeContents(span);
                        selection.addRange(newRange);
                    } else {
                        // 선택된 텍스트가 없는 경우 - 새로 입력될 텍스트에 적용
                        // 임시 span 생성
                        const span = document.createElement('span');
                        span.style.fontWeight = value;
                        span.innerHTML = '&#8203;'; // Zero-width space
                        range.insertNode(span);
                        
                        // 커서를 span 안으로 이동
                        const newRange = document.createRange();
                        newRange.setStart(span, 0);
                        newRange.setEnd(span, 0);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    }
                }
            }
            // Text align의 경우
            else if (property === 'textAlign') {
                if (value === 'left') document.execCommand('justifyLeft', false, null);
                else if (value === 'center') document.execCommand('justifyCenter', false, null);
                else if (value === 'right') document.execCommand('justifyRight', false, null);
                else if (value === 'justify') document.execCommand('justifyFull', false, null);
            }
            // Line height의 경우
            else if (property === 'lineHeight') {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    
                    // 선택 영역이 있는 경우
                    if (!range.collapsed) {
                        // 선택된 모든 요소의 line-height 변경
                        const container = range.commonAncestorContainer;
                        const parent = container.nodeType === Node.TEXT_NODE ? container.parentElement : container;
                        
                        // 선택 영역 내의 모든 div와 p 태그의 line-height 변경
                        const elements = parent.querySelectorAll('div, p, span');
                        elements.forEach(el => {
                            const rect = el.getBoundingClientRect();
                            const rangeRect = range.getBoundingClientRect();
                            // 선택 영역에 포함되는 요소만 변경
                            if (rect.top >= rangeRect.top && rect.bottom <= rangeRect.bottom) {
                                el.style.lineHeight = value;
                            }
                        });
                        
                        // 부모 요소에도 적용
                        if (parent.style) {
                            parent.style.lineHeight = value;
                        }
                    } else {
                        // 선택 영역이 없는 경우 전체 에디터에 적용
                        const editorContent = document.querySelector('.editor-content');
                        if (editorContent) {
                            editorContent.style.lineHeight = value;
                            // 모든 자식 div에도 적용
                            const allDivs = editorContent.querySelectorAll('div');
                            allDivs.forEach(div => {
                                div.style.lineHeight = value;
                            });
                        }
                    }
                }
            }
            // 기타 속성의 경우
            else {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    
                    // 선택 영역이 있는 경우
                    if (!range.collapsed) {
                        // 복잡한 선택 영역 처리
                        const fragment = range.extractContents();
                        const span = document.createElement('span');
                        span.style[property] = value;
                        span.appendChild(fragment);
                        range.insertNode(span);
                        
                        // 선택 영역 복원
                        selection.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.selectNodeContents(span);
                        selection.addRange(newRange);
                    }
                }
            }
        }

        // Toggle format
        function toggleFormat(command) {
            document.execCommand(command, false, null);
            updateFormatButtons();
        }

        // Update format buttons
        function updateFormatButtons() {
            const buttons = document.querySelectorAll('.format-btn');
            buttons.forEach(btn => {
                const icon = btn.querySelector('i');
                if (icon) {
                    let command = '';
                    if (icon.classList.contains('fa-bold')) command = 'bold';
                    else if (icon.classList.contains('fa-italic')) command = 'italic';
                    else if (icon.classList.contains('fa-underline')) command = 'underline';
                    
                    if (command && document.queryCommandState(command)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            });
        }

        // Update font family and available weights
        function updateFontFamily(fontFamily) {
            // Apply font family
            applyFormat('fontFamily', fontFamily);
            
            // Update available weights based on font
            const weightSelect = document.getElementById('fontWeight');
            const currentWeight = weightSelect.value;
            
            // Define available weights for each font
            const fontWeights = {
                "'Paperlogy', sans-serif": ['100', '200', '300', '400', '500', '600', '700', '800', '900'],
                "'Noto Sans KR', sans-serif": ['100', '300', '400', '500', '700', '900'],
                "'Apple Gothic', sans-serif": ['300', '400', '600', '700'],
                "'Apple Myungjo', serif": ['400', '700'],
                "'Malgun Gothic', sans-serif": ['300', '400', '700'],
                "'Arita Dotum', sans-serif": ['300', '400', '500', '700'],
                "'Nanum Gothic', sans-serif": ['400', '700', '800'],
                "'Nanum Myeongjo', serif": ['400', '700', '800'],
                "'Black Han Sans', sans-serif": ['400'],
                "'Jua', sans-serif": ['400'],
                "'Do Hyeon', sans-serif": ['400'],
                "'BM Dohyeon', sans-serif": ['400'],
                "'BM Hanna', sans-serif": ['400'],
                "'BM Jua', sans-serif": ['400'],
                "'Gowun Dodum', sans-serif": ['400'],
                "'Gowun Batang', serif": ['400', '700'],
                "'tvN Enjoystories', sans-serif": ['700', '900'],
                "'OG Renaissance', sans-serif": ['400']
            };
            
            // Get available weights for selected font (default to standard weights if not defined)
            const availableWeights = fontWeights[fontFamily] || ['300', '400', '500', '600', '700'];
            
            // Clear current options
            weightSelect.innerHTML = '';
            
            // Weight labels
            const weightLabels = {
                '100': 'Thin',
                '200': 'ExtraLight',
                '300': 'Light',
                '400': 'Regular',
                '500': 'Medium',
                '600': 'SemiBold',
                '700': 'Bold',
                '800': 'ExtraBold',
                '900': 'Black'
            };
            
            // Add available weight options
            availableWeights.forEach(weight => {
                const option = document.createElement('option');
                option.value = weight;
                option.textContent = weightLabels[weight] || weight;
                weightSelect.appendChild(option);
            });
            
            // Try to maintain current weight if available, otherwise select default
            if (availableWeights.includes(currentWeight)) {
                weightSelect.value = currentWeight;
            } else if (availableWeights.includes('400')) {
                weightSelect.value = '400';
            } else {
                weightSelect.value = availableWeights[0];
            }
            
            // Apply the selected weight
            applyFormat('fontWeight', weightSelect.value);
        }

        // Change font size
        function changeFontSize(delta) {
            const input = document.getElementById('fontSize');
            const newSize = parseInt(input.value) + delta;
            if (newSize >= 8 && newSize <= 144) {
                input.value = newSize;
                applyFormat('fontSize', newSize + 'px');
            }
        }

        // Set alignment
        function setAlignment(alignment) {
            applyFormat('textAlign', alignment);
            
            // Update active button
            document.querySelectorAll('.align-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.align-btn').classList.add('active');
        }

        // Insert list
        function insertList(type) {
            if (type === 'ul') {
                document.execCommand('insertUnorderedList', false, null);
            } else {
                document.execCommand('insertOrderedList', false, null);
            }
        }

        // Open emoji picker
        let selectedEmojis = [];
        
        function openEmojiPicker() {
            // Reset selected emojis
            selectedEmojis = [];
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            overlay.id = 'emojiOverlay';

            // Create dialog
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                max-width: 90%;
                width: 500px;
                max-height: 80vh;
                display: flex;
                flex-direction: column;
            `;

            // Title and selected display
            const headerContainer = document.createElement('div');
            headerContainer.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            `;
            
            const title = document.createElement('h3');
            title.textContent = '이모티콘 선택';
            title.style.cssText = `
                margin: 0;
                font-size: 18px;
                font-weight: bold;
                color: #333;
            `;
            
            const selectedDisplay = document.createElement('div');
            selectedDisplay.id = 'selectedEmojiDisplay';
            selectedDisplay.style.cssText = `
                display: flex;
                gap: 5px;
                padding: 5px 10px;
                background: #f0f0f0;
                border-radius: 6px;
                min-height: 32px;
                align-items: center;
                flex-wrap: wrap;
                max-width: 200px;
            `;
            
            headerContainer.appendChild(title);
            headerContainer.appendChild(selectedDisplay);
            dialog.appendChild(headerContainer);
            
            // Initialize selected display
            updateSelectedDisplay();

            // Tab container
            const tabContainer = document.createElement('div');
            tabContainer.style.cssText = `
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
                border-bottom: 2px solid #e0e0e0;
            `;

            // Tab buttons
            const tabs = ['이모지', 'ASCII 아트', '특수문자'];
            tabs.forEach((tabName, index) => {
                const tabBtn = document.createElement('button');
                tabBtn.textContent = tabName;
                tabBtn.style.cssText = `
                    padding: 8px 16px;
                    background: none;
                    border: none;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: ${index === 0 ? 'bold' : 'normal'};
                    color: ${index === 0 ? '#007AFF' : '#666'};
                    border-bottom: ${index === 0 ? '2px solid #007AFF' : 'none'};
                    margin-bottom: -2px;
                `;
                tabBtn.onclick = () => switchEmojiTab(tabName, tabBtn);
                tabContainer.appendChild(tabBtn);
            });
            dialog.appendChild(tabContainer);

            // Content container
            const contentContainer = document.createElement('div');
            contentContainer.id = 'emojiContentContainer';
            contentContainer.style.cssText = `
                min-height: 300px;
                overflow-y: auto;
                flex: 1;
            `;
            dialog.appendChild(contentContainer);

            // Button container
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 10px;
                margin-top: 15px;
            `;

            // Save button
            const saveButton = document.createElement('button');
            saveButton.textContent = '저장';
            saveButton.style.cssText = `
                flex: 1;
                padding: 10px;
                background: #007AFF;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
            `;
            saveButton.addEventListener('click', () => {
                if (selectedEmojis.length > 0) {
                    insertSelectedEmojis();
                } else {
                    showToast('선택된 이모티콘이 없습니다');
                }
                document.body.removeChild(overlay);
            });
            buttonContainer.appendChild(saveButton);

            // Close button
            const closeButton = document.createElement('button');
            closeButton.textContent = '닫기';
            closeButton.style.cssText = `
                flex: 1;
                padding: 10px;
                background: #f0f0f0;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
            `;
            closeButton.addEventListener('click', () => {
                document.body.removeChild(overlay);
            });
            buttonContainer.appendChild(closeButton);
            
            dialog.appendChild(buttonContainer);

            // Overlay click to close
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // Load default tab
            loadEmojiContent('이모지');
        }

        // Switch emoji tab
        function switchEmojiTab(tabName, tabBtn) {
            // Update tab styles
            const tabs = tabBtn.parentElement.children;
            for (let tab of tabs) {
                tab.style.fontWeight = 'normal';
                tab.style.color = '#666';
                tab.style.borderBottom = 'none';
            }
            tabBtn.style.fontWeight = 'bold';
            tabBtn.style.color = '#007AFF';
            tabBtn.style.borderBottom = '2px solid #007AFF';

            // Load content
            loadEmojiContent(tabName);
        }

        // Load emoji content
        function loadEmojiContent(tabName) {
            const container = document.getElementById('emojiContentContainer');
            container.innerHTML = '';

            if (tabName === '이모지') {
                // Popular emojis
                const emojis = [
                    // 표정
                    '😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇',
                    '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚',
                    '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩',
                    '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣', '😖',
                    '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬', '🤯',
                    '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗', '🤔',
                    '🤭', '🤫', '🤥', '😶', '😐', '😑', '😬', '🙄', '😯', '😦',
                    '😧', '😮', '😲', '🥱', '😴', '🤤', '😪', '😵', '🤐', '🥴',
                    '🤢', '🤮', '🤧', '😷', '🤒', '🤕', '🤑', '🤠', '😈', '👿',
                    // 손 제스처
                    '👋', '🤚', '🖐', '✋', '🖖', '👌', '🤌', '🤏', '✌️', '🤞',
                    '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍',
                    '👎', '👊', '✊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝',
                    '🙏', '✍️', '💅', '🤳', '💪', '🦾', '🦿', '🦵', '🦶', '👂',
                    // 동물
                    '🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯',
                    '🦁', '🐮', '🐷', '🐽', '🐸', '🐵', '🙈', '🙉', '🙊', '🐒',
                    '🐔', '🐧', '🐦', '🐤', '🐣', '🐥', '🦆', '🦅', '🦉', '🦇',
                    '🐺', '🐗', '🐴', '🦄', '🐝', '🐛', '🦋', '🐌', '🐞', '🐜',
                    // 음식
                    '🍏', '🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🍈',
                    '🍒', '🍑', '🥭', '🍍', '🥥', '🥝', '🍅', '🍆', '🥑', '🥦',
                    '🥒', '🌶', '🌽', '🥕', '🥔', '🍠', '🥐', '🍞', '🥖', '🥨',
                    '🧀', '🥚', '🍳', '🥓', '🥞', '🍤', '🍗', '🍖', '🍕', '🌭',
                    '🍔', '🍟', '🥙', '🌮', '🌯', '🥗', '🥘', '🍝', '🍜', '🍲',
                    '🍱', '🍣', '🍛', '🍙', '🍚', '🍘', '🍥', '🍢', '🍡', '🍧',
                    '🍨', '🍦', '🍰', '🎂', '🧁', '🍮', '🍭', '🍬', '🍫', '🍿',
                    '🍩', '🍪', '🥛', '☕', '🍵', '🍶', '🍺', '🍻', '🥂', '🍷',
                    // 하트
                    '❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔',
                    '❣️', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟', '☮️',
                    // 기타
                    '✨', '💫', '⭐', '🌟', '💥', '💢', '💯', '🔥', '🌈', '☀️',
                    '🌤', '⛅', '🌥', '☁️', '🌦', '🌧', '⛈', '🌩', '🌨', '❄️'
                ];

                const emojiGrid = document.createElement('div');
                emojiGrid.style.cssText = `
                    display: grid;
                    grid-template-columns: repeat(10, 1fr);
                    gap: 5px;
                `;

                emojis.forEach(emoji => {
                    const emojiBtn = document.createElement('button');
                    emojiBtn.textContent = emoji;
                    emojiBtn.style.cssText = `
                        width: 40px;
                        height: 40px;
                        border: 1px solid #e0e0e0;
                        background: white;
                        cursor: pointer;
                        font-size: 20px;
                        border-radius: 6px;
                        transition: all 0.2s;
                    `;
                    emojiBtn.onmouseover = () => {
                        emojiBtn.style.background = '#f0f0f0';
                        emojiBtn.style.transform = 'scale(1.1)';
                    };
                    emojiBtn.onmouseout = () => {
                        emojiBtn.style.background = 'white';
                        emojiBtn.style.transform = 'scale(1)';
                    };
                    emojiBtn.onclick = () => insertEmoji(emoji);
                    emojiGrid.appendChild(emojiBtn);
                });

                container.appendChild(emojiGrid);
            } else if (tabName === 'ASCII 아트') {
                // ASCII art emoticons
                const asciiArts = [
                    // 기본 표정
                    { text: '^^', desc: '웃음' },
                    { text: '^_^', desc: '행복' },
                    { text: 'T_T', desc: '울음' },
                    { text: 'ㅠ_ㅠ', desc: '슬픔' },
                    { text: 'o_o', desc: '놀람' },
                    { text: 'O_O', desc: '충격' },
                    { text: '-_-', desc: '무표정' },
                    { text: '=_=', desc: '졸림' },
                    { text: '>_<', desc: '아픔' },
                    { text: '@_@', desc: '어지러움' },
                    { text: '*_*', desc: '반함' },
                    { text: '+_+', desc: '죽음' },
                    // 복잡한 이모티콘
                    { text: '(￣▽￣)', desc: '만족' },
                    { text: '(｡◕‿◕｡)', desc: '귀여움' },
                    { text: '(◕‿◕)', desc: '미소' },
                    { text: '(◡‿◡✿)', desc: '꽃미소' },
                    { text: '(◕‿-)', desc: '윙크' },
                    { text: '(；一_一)', desc: '한심' },
                    { text: '(¬_¬)', desc: '의심' },
                    { text: '(╯°□°）╯︵ ┻━┻', desc: '화남' },
                    { text: '┬─┬ノ( º _ ºノ)', desc: '진정' },
                    { text: '¯\\_(ツ)_/¯', desc: '어쩔' },
                    { text: '(づ｡◕‿‿◕｡)づ', desc: '포옹' },
                    { text: 'ლ(╹◡╹ლ)', desc: '가져와' },
                    { text: '(ﾉ◕ヮ◕)ﾉ*:･ﾟ✧', desc: '신남' },
                    { text: '(｡♥‿♥｡)', desc: '사랑' },
                    { text: '(✿◠‿◠)', desc: '꽃' },
                    { text: 'ヽ(´▽`)/', desc: '만세' },
                    { text: '(´･ω･`)', desc: '걱정' },
                    { text: '(｀・ω・´)', desc: '결의' },
                    { text: '( ͡° ͜ʖ ͡°)', desc: '음흉' },
                    { text: '( ͡~ ͜ʖ ͡°)', desc: '윙크2' },
                    // 동작
                    { text: 'ヽ(^o^)丿', desc: '춤' },
                    { text: '♪～(´ε｀ )', desc: '휘파람' },
                    { text: '＼(^o^)／', desc: '환호' },
                    { text: '(／_＼)', desc: '부끄러움' },
                    { text: '(>_<)', desc: '짜증' },
                    { text: '(×_×)', desc: '죽음2' },
                    { text: '(=^･^=)', desc: '고양이' },
                    { text: '(･∀･)', desc: '좋아' },
                    { text: '(ಠ_ಠ)', desc: '불만' },
                    { text: '(ಥ_ಥ)', desc: '눈물' }
                ];

                const asciiGrid = document.createElement('div');
                asciiGrid.style.cssText = `
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 8px;
                `;

                asciiArts.forEach(art => {
                    const artBtn = document.createElement('button');
                    artBtn.style.cssText = `
                        padding: 8px 12px;
                        border: 1px solid #e0e0e0;
                        background: white;
                        cursor: pointer;
                        border-radius: 6px;
                        transition: all 0.2s;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 4px;
                    `;
                    
                    const textSpan = document.createElement('span');
                    textSpan.textContent = art.text;
                    textSpan.style.cssText = `
                        font-family: monospace;
                        font-size: 16px;
                        font-weight: bold;
                    `;
                    
                    const descSpan = document.createElement('span');
                    descSpan.textContent = art.desc;
                    descSpan.style.cssText = `
                        font-size: 11px;
                        color: #666;
                    `;
                    
                    artBtn.appendChild(textSpan);
                    artBtn.appendChild(descSpan);
                    
                    artBtn.onmouseover = () => {
                        artBtn.style.background = '#f0f0f0';
                        artBtn.style.transform = 'scale(1.05)';
                    };
                    artBtn.onmouseout = () => {
                        artBtn.style.background = 'white';
                        artBtn.style.transform = 'scale(1)';
                    };
                    artBtn.onclick = () => insertEmoji(art.text);
                    asciiGrid.appendChild(artBtn);
                });

                container.appendChild(asciiGrid);
            } else if (tabName === '특수문자') {
                // Special characters
                const specialChars = [
                    // 화살표
                    '→', '←', '↑', '↓', '↔', '↕', '↗', '↖', '↘', '↙',
                    '⇒', '⇐', '⇑', '⇓', '⇔', '⇕', '➜', '➡', '⬅', '⬆',
                    '⬇', '↪', '↩', '⤴', '⤵', '🔃', '🔄', '🔙', '🔚', '🔛',
                    // 기호
                    '★', '☆', '✦', '✧', '♠', '♣', '♥', '♦', '♪', '♫',
                    '☀', '☁', '☂', '☃', '☄', '♨', '✿', '❀', '❁', '❃',
                    '❄', '❅', '❆', '☕', '☎', '☏', '✂', '✈', '✉', '✏',
                    '✒', '📌', '📍', '📎', '🔒', '🔓', '🔍', '🔎', '💡', '🔔',
                    // 수학기호
                    '＋', '－', '×', '÷', '＝', '≠', '≈', '≤', '≥', '±',
                    '∞', '∑', '∏', '∫', '√', '∛', 'π', '∠', '⊥', '∥',
                    // 괄호
                    '「', '」', '『', '』', '【', '】', '〔', '〕', '〖', '〗',
                    '《', '》', '〈', '〉', '「', '」', '［', '］', '｛', '｝',
                    // 기타
                    '©', '®', '™', '℃', '℉', '№', '℡', '㎡', '㎥', '㎝',
                    '㎞', '㎏', '￥', '＄', '￡', '€', '¢', '¤', '°', '′',
                    '″', '‰', '§', '¶', '†', '‡', '•', '‥', '…', '‼',
                    '⁇', '⁈', '⁉', '※', '＊', '＃', '＆', '＠', '￼', '〓'
                ];

                const charGrid = document.createElement('div');
                charGrid.style.cssText = `
                    display: grid;
                    grid-template-columns: repeat(10, 1fr);
                    gap: 5px;
                `;

                specialChars.forEach(char => {
                    const charBtn = document.createElement('button');
                    charBtn.textContent = char;
                    charBtn.style.cssText = `
                        width: 40px;
                        height: 40px;
                        border: 1px solid #e0e0e0;
                        background: white;
                        cursor: pointer;
                        font-size: 18px;
                        border-radius: 6px;
                        transition: all 0.2s;
                    `;
                    charBtn.onmouseover = () => {
                        charBtn.style.background = '#f0f0f0';
                        charBtn.style.transform = 'scale(1.1)';
                    };
                    charBtn.onmouseout = () => {
                        charBtn.style.background = 'white';
                        charBtn.style.transform = 'scale(1)';
                    };
                    charBtn.onclick = () => insertEmoji(char);
                    charGrid.appendChild(charBtn);
                });

                container.appendChild(charGrid);
            }
        }

        // Insert emoji to selected list
        function insertEmoji(emoji) {
            // Add to selected emojis array
            if (!selectedEmojis.includes(emoji)) {
                selectedEmojis.push(emoji);
                updateSelectedDisplay();
                console.log('Added emoji:', emoji, 'Total:', selectedEmojis.length);
            } else {
                console.log('Emoji already selected:', emoji);
            }
        }
        
        // Update selected emoji display
        function updateSelectedDisplay() {
            const display = document.getElementById('selectedEmojiDisplay');
            console.log('Updating display, selected emojis:', selectedEmojis);
            if (display) {
                if (selectedEmojis.length === 0) {
                    display.innerHTML = '<span style="color: #999; font-size: 12px;">선택된 이모티콘이 없습니다</span>';
                } else {
                    display.innerHTML = selectedEmojis.map(emoji => 
                        `<span style="font-size: 20px; cursor: pointer; margin: 2px;" onclick="removeEmoji('${emoji}')" title="클릭하여 제거">${emoji}</span>`
                    ).join('');
                }
            } else {
                console.error('selectedEmojiDisplay element not found');
            }
        }
        
        // Remove emoji from selection
        window.removeEmoji = function(emoji) {
            const index = selectedEmojis.indexOf(emoji);
            if (index > -1) {
                selectedEmojis.splice(index, 1);
                updateSelectedDisplay();
            }
        }
        
        // Insert selected emojis to editor
        function insertSelectedEmojis() {
            if (selectedEmojis.length === 0) {
                showToast('선택된 이모티콘이 없습니다');
                return;
            }
            
            // Get editor content
            const editorContent = document.querySelector('.editor-content');
            if (!editorContent) {
                showToast('에디터를 찾을 수 없습니다');
                return;
            }
            
            // Focus the editor
            editorContent.focus();
            
            // Get current selection or create at the end
            const selection = window.getSelection();
            let range;
            
            if (selection.rangeCount > 0 && editorContent.contains(selection.anchorNode)) {
                // Use existing selection if it's within the editor
                range = selection.getRangeAt(0);
            } else {
                // Create new range at the end of editor
                range = document.createRange();
                range.selectNodeContents(editorContent);
                range.collapse(false); // Collapse to end
            }
            
            // Insert all selected emojis with space between them
            const emojiText = selectedEmojis.join(' ') + ' '; // Add space after emojis
            const textNode = document.createTextNode(emojiText);
            range.insertNode(textNode);
            
            // Move cursor after the emojis
            range.setStartAfter(textNode);
            range.setEndAfter(textNode);
            selection.removeAllRanges();
            selection.addRange(range);
            
            // Show success message
            showToast(`${selectedEmojis.length}개의 이모티콘이 삽입되었습니다`);
            
            // Clear selected emojis
            selectedEmojis = [];
        }

        // Upload images to gallery
        function uploadImages(input) {
            const files = Array.from(input.files);
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addImageToGallery(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Add image to gallery
        function addImageToGallery(src) {
            const imageId = 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            uploadedImages.push({ id: imageId, src: src });
            
            const galleryItem = document.createElement('div');
            galleryItem.className = 'gallery-item';
            galleryItem.dataset.imageId = imageId;
            galleryItem.draggable = true;
            galleryItem.innerHTML = `
                <img src="${src}" alt="Uploaded image">
                <button class="delete-btn" onclick="removeFromGallery('${imageId}')" title="삭제">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Add drag event listeners
            galleryItem.addEventListener('dragstart', handleGalleryDragStart);
            galleryItem.addEventListener('dragend', handleGalleryDragEnd);
            
            // Add double-click event listener
            galleryItem.addEventListener('dblclick', function() {
                const image = uploadedImages.find(img => img.id === imageId);
                if (image) {
                    // Focus on the editor
                    const editorContent = document.querySelector('.editor-content');
                    editorContent.focus();
                    
                    // Place cursor at the end
                    const selection = window.getSelection();
                    const range = document.createRange();
                    range.selectNodeContents(editorContent);
                    range.collapse(false);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                    // Insert image
                    insertImageAtCursor(image.src);
                }
            });
            
            document.getElementById('imageGallery').appendChild(galleryItem);
            showToast('이미지가 갤러리에 추가되었습니다');
        }

        // Remove image from gallery
        function removeFromGallery(imageId) {
            uploadedImages = uploadedImages.filter(img => img.id !== imageId);
            const galleryItem = document.querySelector(`[data-image-id="${imageId}"]`);
            if (galleryItem) {
                galleryItem.remove();
                showToast('이미지가 삭제되었습니다');
            }
        }

        // Gallery drag start
        function handleGalleryDragStart(e) {
            e.target.classList.add('dragging');
            const imageId = e.target.dataset.imageId;
            const image = uploadedImages.find(img => img.id === imageId);
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('imageData', JSON.stringify(image));
        }

        // Gallery drag end
        function handleGalleryDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        // Insert image at cursor
        function insertImageAtCursor(src, x, y) {
            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-container';
            imageContainer.style.width = '200px'; // Default width
            
            // Position at cursor or default position
            if (x && y) {
                const editorContent = document.querySelector('.editor-content');
                const rect = editorContent.getBoundingClientRect();
                imageContainer.style.left = (x - rect.left) + 'px';
                imageContainer.style.top = (y - rect.top) + 'px';
            } else {
                // Default center position
                imageContainer.style.left = '50%';
                imageContainer.style.top = '20px';
                imageContainer.style.transform = 'translateX(-50%)';
            }
            
            imageContainer.innerHTML = `
                <img src="${src}" class="inserted-image" draggable="false">
                <div class="resize-handles">
                    <div class="resize-handle top-left" data-handle="top-left"></div>
                    <div class="resize-handle top" data-handle="top"></div>
                    <div class="resize-handle top-right" data-handle="top-right"></div>
                    <div class="resize-handle right" data-handle="right"></div>
                    <div class="resize-handle bottom-right" data-handle="bottom-right"></div>
                    <div class="resize-handle bottom" data-handle="bottom"></div>
                    <div class="resize-handle bottom-left" data-handle="bottom-left"></div>
                    <div class="resize-handle left" data-handle="left"></div>
                </div>
                <div class="image-controls">
                    <button class="image-control-btn" onclick="alignImage(this, 'left')" title="왼쪽 정렬">
                        <i class="fas fa-align-left"></i>
                    </button>
                    <button class="image-control-btn" onclick="alignImage(this, 'center')" title="가운데 정렬">
                        <i class="fas fa-align-center"></i>
                    </button>
                    <button class="image-control-btn" onclick="alignImage(this, 'right')" title="오른쪽 정렬">
                        <i class="fas fa-align-right"></i>
                    </button>
                    <button class="image-control-btn" onclick="toggleImageMode(this)" title="인라인/블록">
                        <i class="fas fa-arrows-alt-h"></i>
                    </button>
                    <button class="image-control-btn" onclick="deleteImage(this)" title="삭제">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Add click event
            imageContainer.addEventListener('click', function(e) {
                if (!e.target.classList.contains('resize-handle') && !e.target.closest('.image-control-btn')) {
                    selectImage(this);
                }
            });
            
            // Add drag functionality
            imageContainer.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('resize-handle') || e.target.closest('.image-control-btn')) {
                    return;
                }
                
                e.preventDefault();
                selectImage(this);
                
                const startX = e.clientX;
                const startY = e.clientY;
                const startLeft = parseInt(this.style.left) || 0;
                const startTop = parseInt(this.style.top) || 0;
                const container = this;
                
                container.classList.add('dragging');
                
                function handleMouseMove(e) {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    container.style.left = (startLeft + deltaX) + 'px';
                    container.style.top = (startTop + deltaY) + 'px';
                    container.style.transform = 'none'; // Remove any transform
                }
                
                function handleMouseUp() {
                    container.classList.remove('dragging');
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                }
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });
            
            // Add resize event listeners
            const handles = imageContainer.querySelectorAll('.resize-handle');
            handles.forEach(handle => {
                handle.addEventListener('mousedown', startResize);
            });
            
            // Add to editor content
            const editorContent = document.querySelector('.editor-content');
            editorContent.appendChild(imageContainer);
            
            showToast('이미지가 추가되었습니다');
        }

        // Select image
        function selectImage(container) {
            document.querySelectorAll('.image-container').forEach(c => {
                c.classList.remove('selected');
            });
            
            container.classList.add('selected');
            selectedImage = container;
        }

        // Start resize
        function startResize(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const container = e.target.closest('.image-container');
            const handle = e.target.dataset.handle;
            
            resizing = true;
            resizeData = {
                container: container,
                handle: handle,
                startX: e.clientX,
                startY: e.clientY,
                startWidth: container.offsetWidth,
                startHeight: container.offsetHeight,
                aspectRatio: container.offsetWidth / container.offsetHeight
            };
            
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
            
            document.body.style.cursor = e.target.style.cursor;
        }

        // Do resize
        function doResize(e) {
            if (!resizing || !resizeData) return;
            
            const dx = e.clientX - resizeData.startX;
            const dy = e.clientY - resizeData.startY;
            let newWidth = resizeData.startWidth;
            let newHeight = resizeData.startHeight;
            
            switch (resizeData.handle) {
                case 'right':
                    newWidth = resizeData.startWidth + dx;
                    break;
                case 'left':
                    newWidth = resizeData.startWidth - dx;
                    break;
                case 'bottom':
                    newHeight = resizeData.startHeight + dy;
                    break;
                case 'top':
                    newHeight = resizeData.startHeight - dy;
                    break;
                case 'bottom-right':
                    newWidth = resizeData.startWidth + dx;
                    newHeight = newWidth / resizeData.aspectRatio;
                    break;
                case 'bottom-left':
                    newWidth = resizeData.startWidth - dx;
                    newHeight = newWidth / resizeData.aspectRatio;
                    break;
                case 'top-right':
                    newWidth = resizeData.startWidth + dx;
                    newHeight = newWidth / resizeData.aspectRatio;
                    break;
                case 'top-left':
                    newWidth = resizeData.startWidth - dx;
                    newHeight = newWidth / resizeData.aspectRatio;
                    break;
            }
            
            // Minimum size
            newWidth = Math.max(50, newWidth);
            newHeight = Math.max(50, newHeight);
            
            // Maximum size (container width)
            const maxWidth = resizeData.container.parentElement.offsetWidth - 120; // padding
            newWidth = Math.min(maxWidth, newWidth);
            
            resizeData.container.style.width = newWidth + 'px';
            if (resizeData.handle !== 'left' && resizeData.handle !== 'right') {
                resizeData.container.style.height = newHeight + 'px';
            }
        }

        // Stop resize
        function stopResize() {
            resizing = false;
            resizeData = null;
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
            document.body.style.cursor = '';
        }

        // Delete image
        function deleteImage(btn) {
            btn.closest('.image-container').remove();
            selectedImage = null;
            showToast('이미지가 삭제되었습니다');
        }
        
        // Align image
        function alignImage(btn, alignment) {
            const container = btn.closest('.image-container');
            const editorContent = container.parentElement;
            const editorWidth = editorContent.offsetWidth;
            const imageWidth = container.offsetWidth;
            
            container.style.transform = 'none';
            
            switch(alignment) {
                case 'left':
                    container.style.left = '0px';
                    break;
                case 'center':
                    container.style.left = ((editorWidth - imageWidth) / 2) + 'px';
                    break;
                case 'right':
                    container.style.left = (editorWidth - imageWidth) + 'px';
                    break;
            }
            
            showToast(`이미지가 ${alignment === 'left' ? '왼쪽' : alignment === 'center' ? '가운데' : '오른쪽'}으로 정렬되었습니다`);
        }
        
        // Toggle image mode (absolute/inline)
        function toggleImageMode(btn) {
            const container = btn.closest('.image-container');
            
            if (container.style.position === 'absolute') {
                // Switch to inline mode
                container.style.position = 'relative';
                container.style.left = 'auto';
                container.style.top = 'auto';
                container.style.transform = 'none';
                container.style.display = 'block';
                container.style.margin = '8px auto';
                showToast('인라인 모드로 변경되었습니다');
            } else {
                // Switch to absolute mode
                container.style.position = 'absolute';
                container.style.left = '50%';
                container.style.top = '20px';
                container.style.transform = 'translateX(-50%)';
                container.style.display = 'inline-block';
                container.style.margin = '0';
                showToast('자유 배치 모드로 변경되었습니다');
            }
        }

        // Drag and drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            if (e.currentTarget.classList.contains('image-upload-area')) {
                e.currentTarget.classList.add('dragover');
            }
        }

        function handleDragLeave(e) {
            if (e.currentTarget.classList.contains('image-upload-area')) {
                e.currentTarget.classList.remove('dragover');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            
            // Check if it's an image from gallery
            const imageData = e.dataTransfer.getData('imageData');
            if (imageData) {
                const image = JSON.parse(imageData);
                insertImageAtCursor(image.src, e.clientX, e.clientY);
                return;
            }
            
            // Handle file drop
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    insertImageAtCursor(event.target.result, e.clientX, e.clientY);
                };
                reader.readAsDataURL(files[0]);
            }
        }

        // Handle drop to gallery
        function handleDropToGallery(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            const validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
            
            validFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    addImageToGallery(event.target.result);
                };
                reader.readAsDataURL(file);
            });
        }

        // Handle paste
        function handlePaste(e) {
            const items = e.clipboardData.items;
            let hasTextContent = false;
            
            for (let item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        insertImageAtCursor(event.target.result);
                    };
                    reader.readAsDataURL(blob);
                    break;
                } else if (item.type === 'text/plain') {
                    hasTextContent = true;
                }
            }
            
            // 텍스트 붙여넣기의 경우 스타일 제거
            if (hasTextContent) {
                e.preventDefault();
                
                // 플레인 텍스트 가져오기
                const text = e.clipboardData.getData('text/plain');
                
                // 현재 줄 간격 설정 가져오기
                const lineHeightSelect = document.querySelector('select[onchange*="lineHeight"]');
                const currentLineHeight = lineHeightSelect ? lineHeightSelect.value : '1.8';
                
                // 텍스트를 현재 스타일로 삽입
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    
                    // 텍스트를 줄 단위로 분리
                    const lines = text.split('\n');
                    
                    lines.forEach((line, index) => {
                        if (line.trim() || index < lines.length - 1) {
                            // div로 각 줄을 감싸서 줄 간격 적용
                            const lineDiv = document.createElement('div');
                            lineDiv.style.lineHeight = currentLineHeight;
                            lineDiv.textContent = line || '\u200B'; // 빈 줄의 경우 zero-width space
                            range.insertNode(lineDiv);
                            range.setStartAfter(lineDiv);
                        }
                    });
                    
                    // 커서를 마지막 위치로 이동
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
        }

        // Add page
        function addPage() {
            pageCounter++;
            const newPage = document.createElement('div');
            newPage.className = 'page';
            newPage.id = `page${pageCounter}`;
            
            // 현재 페이지의 여백 설정 가져오기
            const existingPage = document.querySelector('.page');
            if (existingPage) {
                newPage.style.padding = existingPage.style.padding;
            }
            
            newPage.innerHTML = `
                <div class="editor-content" contenteditable="true" 
                     onpaste="handlePaste(event)" 
                     ondrop="handleDrop(event)" 
                     ondragover="handleDragOver(event)"
                     ondragenter="handleDragEnter(event)"
                     oninput="updateContent()">
                    <p>새 페이지 내용을 입력하세요...</p>
                </div>
                <div class="page-number">${pageCounter}</div>
            `;
            
            const addButton = document.querySelector('.add-page-btn');
            addButton.parentNode.insertBefore(newPage, addButton);
            
            newPage.scrollIntoView({ behavior: 'smooth', block: 'center' });
            showToast('새 페이지가 추가되었습니다');
        }

        // Update page numbers
        function updatePageNumbers() {
            const pages = document.querySelectorAll('.page');
            pages.forEach((page, index) => {
                const pageNumber = page.querySelector('.page-number');
                if (pageNumber) {
                    pageNumber.textContent = index + 1;
                }
                page.id = `page${index + 1}`;
            });
            pageCounter = pages.length;
        }

        // Save document
        function saveDocument() {
            const pages = Array.from(document.querySelectorAll('.page')).map(page => {
                return {
                    content: page.querySelector('.editor-content').innerHTML
                };
            });

            currentDocument.pages = pages;

            const dataStr = JSON.stringify(currentDocument, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${currentDocument.title}.json`;
            link.click();
            
            showToast('문서가 저장되었습니다');
        }

        // Open document
        function openDocument() {
            document.getElementById('fileInput').click();
        }

        // Load document
        function loadDocument(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        loadDocumentData(data);
                        showToast('문서가 로드되었습니다');
                    } catch (error) {
                        showToast('파일을 읽을 수 없습니다');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Load document data
        function loadDocumentData(data) {
            currentDocument = data;
            document.getElementById('documentTitle').value = data.title;
            
            // Remove existing pages except first
            document.querySelectorAll('.page:not(:first-child)').forEach(page => page.remove());
            
            // Update first page or create pages
            if (data.pages.length > 0) {
                document.querySelector('.page .editor-content').innerHTML = data.pages[0].content;
                
                // Add remaining pages
                for (let i = 1; i < data.pages.length; i++) {
                    pageCounter++;
                    const newPage = document.createElement('div');
                    newPage.className = 'page';
                    newPage.id = `page${pageCounter}`;
                    newPage.innerHTML = `
                        <div class="editor-content" contenteditable="true" 
                             onpaste="handlePaste(event)" 
                             ondrop="handleDrop(event)" 
                             ondragover="handleDragOver(event)"
                             ondragenter="handleDragEnter(event)"
                             oninput="updateContent()">
                            ${data.pages[i].content}
                        </div>
                        <div class="page-number">${pageCounter}</div>
                    `;
                    
                    const addButton = document.querySelector('.add-page-btn');
                    addButton.parentNode.insertBefore(newPage, addButton);
                }
            }
            
            updatePageNumbers();
        }

        // Export to PDF
        async function exportToPDF() {
            showToast('PDF를 생성하고 있습니다...');
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const pages = document.querySelectorAll('.page');
            
            for (let i = 0; i < pages.length; i++) {
                if (i > 0) {
                    pdf.addPage();
                }
                
                try {
                    const canvas = await html2canvas(pages[i], {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff'
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210; // A4 width in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                } catch (error) {
                    console.error('페이지 렌더링 오류:', error);
                }
            }
            
            pdf.save(`${currentDocument.title}.pdf`);
            showToast('PDF가 다운로드되었습니다');
        }

        // Update color code display when color picker changes
        function updateColorCode(type, color) {
            const codeInput = document.getElementById(type + 'ColorCode');
            if (codeInput) {
                codeInput.value = color.toUpperCase();
            }
            const valueDisplay = document.getElementById(type + 'ColorValue');
            if (valueDisplay) {
                valueDisplay.textContent = color.toUpperCase();
            }
            
            // Update LEGO button color if it exists
            const colorButton = document.getElementById(type + 'ColorButton');
            if (colorButton) {
                colorButton.style.background = color;
                const darker1 = adjustColor(color, -30);
                const darker2 = adjustColor(color, -50);
                colorButton.style.boxShadow = `0 2px 0 0 ${darker1}, 0 4px 0 0 ${darker2}, 0 4px 8px rgba(0,0,0,0.2)`;
            }
        }
        
        // Helper function to adjust color brightness
        function adjustColor(color, amount) {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }

        // Update color picker when code is entered
        function updateColorFromCode(type, code) {
            // Validate color code
            const colorRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
            
            // Add # if missing
            if (!code.startsWith('#')) {
                code = '#' + code;
            }
            
            if (colorRegex.test(code)) {
                // Convert 3-digit to 6-digit if needed
                if (code.length === 4) {
                    code = '#' + code[1] + code[1] + code[2] + code[2] + code[3] + code[3];
                }
                
                // Update color picker
                const colorPicker = document.getElementById(type + 'Color');
                if (colorPicker) {
                    colorPicker.value = code;
                    
                    // Apply the color
                    if (type === 'text') {
                        applyFormat('color', code);
                    }
                }
                
                // Update display
                updateColorCode(type, code);
            } else {
                // Invalid color code - revert to current color
                const colorPicker = document.getElementById(type + 'Color');
                if (colorPicker) {
                    const codeInput = document.getElementById(type + 'ColorCode');
                    codeInput.value = colorPicker.value.toUpperCase();
                }
                showToast('올바른 색상 코드를 입력하세요 (예: #FF0000)');
            }
        }

        // Show toast
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Update content
        function updateContent() {
            // Auto-save logic can be added here
        }
        
        // ==================== SHAPE FUNCTIONS ====================
        let shapeIdCounter = 0;
        let selectedShape = null;
        let copiedShape = null;
        
        // Show shape category
        function showShapeCategory(category) {
            // Update tab active state
            document.querySelectorAll('.shape-category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Hide all shape grids
            document.getElementById('basicShapes').style.display = 'none';
            document.getElementById('bubbleShapes').style.display = 'none';
            document.getElementById('lineShapes').style.display = 'none';
            document.getElementById('iconShapes').style.display = 'none';
            
            // Show selected category
            switch(category) {
                case 'basic':
                    document.getElementById('basicShapes').style.display = 'grid';
                    break;
                case 'bubble':
                    document.getElementById('bubbleShapes').style.display = 'grid';
                    break;
                case 'line':
                    document.getElementById('lineShapes').style.display = 'grid';
                    break;
                case 'icon':
                    document.getElementById('iconShapes').style.display = 'grid';
                    break;
            }
        }
        
        // Add shape to editor
        function addShape(shapeType) {
            const editorContent = document.querySelector('.editor-content');
            const shapeElement = document.createElement('div');
            shapeElement.className = 'shape-element';
            shapeElement.id = `shape-${++shapeIdCounter}`;
            shapeElement.style.width = '100px';
            shapeElement.style.height = '100px';
            // Center position without using transform
            const editorRect = editorContent.getBoundingClientRect();
            shapeElement.style.left = (editorRect.width / 2 - 50) + 'px'; // 50 is half of default width
            shapeElement.style.top = '100px';
            
            // Create SVG based on shape type
            let svgContent = getShapeSVG(shapeType);
            shapeElement.innerHTML = svgContent;
            
            // Add shape controls
            const controls = document.createElement('div');
            controls.className = 'image-controls';
            controls.innerHTML = `
                <button class="image-control-btn" onclick="copyShape(this)" title="복사">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="image-control-btn" onclick="toggleShapeFill(this)" title="채우기/테두리">
                    <i class="fas fa-fill-drip"></i>
                </button>
                <button class="image-control-btn" onclick="changeShapeColor(this)" title="색상 변경">
                    <i class="fas fa-palette"></i>
                </button>
                <button class="image-control-btn" onclick="deleteShape(this)" title="삭제">
                    <i class="fas fa-times"></i>
                </button>
            `;
            shapeElement.appendChild(controls);
            
            // Set initial data attributes
            shapeElement.dataset.rotation = '0';
            shapeElement.dataset.fillMode = 'fill'; // 'fill' or 'stroke'
            shapeElement.dataset.currentColor = '#6c757d'; // 초기 색상
            shapeElement.dataset.shapeType = shapeType; // 도형 타입 저장
            
            // Add resize handles
            const resizeHandles = document.createElement('div');
            resizeHandles.className = 'resize-handles';
            resizeHandles.innerHTML = `
                <div class="resize-handle top-left" data-handle="top-left"></div>
                <div class="resize-handle top-right" data-handle="top-right"></div>
                <div class="resize-handle bottom-left" data-handle="bottom-left"></div>
                <div class="resize-handle bottom-right" data-handle="bottom-right"></div>
                <div class="resize-handle top" data-handle="top"></div>
                <div class="resize-handle right" data-handle="right"></div>
                <div class="resize-handle bottom" data-handle="bottom"></div>
                <div class="resize-handle left" data-handle="left"></div>
            `;
            shapeElement.appendChild(resizeHandles);
            
            // Add rotation handle
            const rotationHandle = document.createElement('div');
            rotationHandle.className = 'rotation-handle';
            shapeElement.appendChild(rotationHandle);
            
            // Add rotation functionality
            rotationHandle.addEventListener('mousedown', startShapeRotation);
            
            // Make shape draggable
            makeShapeDraggable(shapeElement);
            
            editorContent.appendChild(shapeElement);
            selectShape(shapeElement);
            showToast(`도형이 추가되었습니다`);
        }
        
        // Get SVG content for shape
        function getShapeSVG(shapeType) {
            const strokeWidth = 3;
            const shapes = {
                'rectangle': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="none"><rect x="10" y="10" width="80" height="80" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /></svg>`,
                'circle': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"><circle cx="50" cy="50" r="40" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /></svg>`,
                'triangle': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="none"><polygon points="50,10 90,80 10,80" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /></svg>`,
                'diamond': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="none"><polygon points="50,10 90,50 50,90 10,50" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /></svg>`,
                'star': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"><polygon points="50,10 61,35 87,35 69,51 76,76 50,61 24,76 31,51 13,35 39,35" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /></svg>`,
                'heart': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"><path d="M50,20 C30,-5 0,5 20,35 L50,75 L80,35 C100,5 70,-5 50,20 Z" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /></svg>`,
                'hexagon': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"><polygon points="50,10 85,30 85,70 50,90 15,70 15,30" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /></svg>`,
                'octagon': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"><polygon points="35,10 65,10 90,35 90,65 65,90 35,90 10,65 10,35" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /></svg>`,
                'arrow-right': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="none"><polygon points="10,35 60,35 60,20 90,50 60,80 60,65 10,65" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /></svg>`,
                'donut': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"><path d="M50,10 A40,40 0 1,1 49.9,10 Z M50,30 A20,20 0 1,0 50.1,30 Z" fill-rule="evenodd" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /></svg>`,
                'speech-bubble': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="none"><path d="M15,15 Q15,5 25,5 L75,5 Q85,5 85,15 L85,50 Q85,60 75,60 L40,60 L25,80 L25,60 L25,60 Q15,60 15,50 Z" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /></svg>`,
                'thought-bubble': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"><ellipse cx="50" cy="35" rx="40" ry="25" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /><circle cx="25" cy="65" r="10" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /><circle cx="15" cy="80" r="6" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /></svg>`,
                'banner': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="none"><path d="M5,25 L95,25 L95,65 L85,55 L95,65 L5,65 L15,55 L5,65 Z" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /></svg>`,
                'ribbon': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="none"><path d="M15,35 L85,35 L92,50 L85,65 L15,65 L8,50 Z" fill="#6c757d" stroke="#6c757d" stroke-width="${strokeWidth}" /></svg>`,
                'line-straight': '<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="none"><line x1="10" y1="50" x2="90" y2="50" stroke="#6c757d" stroke-width="4" /></svg>',
                'line-dashed': '<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="none"><line x1="10" y1="50" x2="90" y2="50" stroke="#6c757d" stroke-width="4" stroke-dasharray="8,4" /></svg>',
                'line-dotted': '<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="none"><line x1="10" y1="50" x2="90" y2="50" stroke="#6c757d" stroke-width="4" stroke-dasharray="2,6" /></svg>',
                'arrow-line': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="none"><defs><marker id="arrow${shapeIdCounter}" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#6c757d" /></marker></defs><line x1="10" y1="50" x2="90" y2="50" stroke="#6c757d" stroke-width="4" marker-end="url(#arrow${shapeIdCounter})" /></svg>`,
                'arrow-double': `<svg viewBox="0 0 100 100" width="100%" height="100%" preserveAspectRatio="none"><defs><marker id="arrowStart${shapeIdCounter}" markerWidth="10" markerHeight="7" refX="1" refY="3.5" orient="auto"><polygon points="10 0, 0 3.5, 10 7" fill="#6c757d" /></marker><marker id="arrowEnd${shapeIdCounter}" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#6c757d" /></marker></defs><line x1="10" y1="50" x2="90" y2="50" stroke="#6c757d" stroke-width="4" marker-start="url(#arrowStart${shapeIdCounter})" marker-end="url(#arrowEnd${shapeIdCounter})" /></svg>`
            };
            
            // Handle icons
            if (shapeType.startsWith('icon-')) {
                const iconMap = {
                    'icon-check': 'fa-check',
                    'icon-heart': 'fa-heart',
                    'icon-star': 'fa-star',
                    'icon-bulb': 'fa-lightbulb',
                    'icon-home': 'fa-home',
                    'icon-user': 'fa-user',
                    'icon-search': 'fa-search',
                    'icon-comment': 'fa-comment'
                };
                const iconClass = iconMap[shapeType] || 'fa-circle';
                return `<i class="fas ${iconClass}" style="font-size: 48px; color: #6c757d; display: block; text-align: center; line-height: 100px;"></i>`;
            }
            
            // Adjust height for line shapes
            if (shapeType.includes('line')) {
                shapeElement.style.height = '20px';
            }
            
            return shapes[shapeType] || shapes['circle'];
        }
        
        // Make shape draggable
        function makeShapeDraggable(shapeElement) {
            let clickTimer = null;
            let isDragging = false;
            
            shapeElement.addEventListener('mousedown', function(e) {
                if (e.target.closest('.image-control-btn') || e.target.classList.contains('resize-handle')) return;
                
                e.preventDefault();
                selectShape(this);
                
                const startX = e.clientX;
                const startY = e.clientY;
                const startLeft = parseInt(this.style.left) || 0;
                const startTop = parseInt(this.style.top) || 0;
                const shape = this;
                
                shape.classList.add('dragging');
                isDragging = false;
                
                function handleMouseMove(e) {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    // 최소 이동 거리를 확인하여 드래그 여부 판단
                    if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                        isDragging = true;
                    }
                    
                    shape.style.left = (startLeft + deltaX) + 'px';
                    shape.style.top = (startTop + deltaY) + 'px';
                    // Keep rotation if exists
                    const rotation = shape.dataset.rotation || '0';
                    shape.style.transform = `rotate(${rotation}deg)`;
                }
                
                function handleMouseUp() {
                    shape.classList.remove('dragging');
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                }
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });
            
            shapeElement.addEventListener('click', function(e) {
                if (!e.target.closest('.image-control-btn') && !e.target.classList.contains('resize-handle') && !isDragging) {
                    selectShape(this);
                    
                    // 더블클릭 감지
                    if (clickTimer) {
                        clearTimeout(clickTimer);
                        clickTimer = null;
                        // 더블클릭 시 본문에 도형 삽입
                        insertShapeToContent(this);
                    } else {
                        clickTimer = setTimeout(() => {
                            clickTimer = null;
                        }, 300);
                    }
                }
            });
            
            // Add resize functionality
            const handles = shapeElement.querySelectorAll('.resize-handle');
            handles.forEach(handle => {
                handle.addEventListener('mousedown', startShapeResize);
            });
        }
        
        // Select shape
        function selectShape(shape) {
            document.querySelectorAll('.shape-element').forEach(s => {
                s.classList.remove('selected');
            });
            shape.classList.add('selected');
            selectedShape = shape;
        }
        
        // Insert shape to content
        function insertShapeToContent(shape) {
            const editorContent = document.querySelector('.editor-content');
            
            // SVG나 아이콘 내용 복사
            const svgElement = shape.querySelector('svg');
            const iconElement = shape.querySelector('i');
            
            if (svgElement) {
                // SVG 도형인 경우
                const svgClone = svgElement.cloneNode(true);
                
                // 인라인 스타일로 크기 설정
                const width = parseInt(shape.style.width);
                const height = parseInt(shape.style.height);
                svgClone.style.width = width + 'px';
                svgClone.style.height = height + 'px';
                svgClone.style.display = 'inline-block';
                svgClone.style.verticalAlign = 'middle';
                
                // 커서 위치에 삽입
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                range.insertNode(svgClone);
                
                // 커서를 도형 뒤로 이동
                range.setStartAfter(svgClone);
                range.setEndAfter(svgClone);
                selection.removeAllRanges();
                selection.addRange(range);
                
                showToast('도형이 본문에 삽입되었습니다');
            } else if (iconElement) {
                // 아이콘인 경우
                const iconClone = iconElement.cloneNode(true);
                iconClone.style.display = 'inline';
                iconClone.style.verticalAlign = 'middle';
                
                // 커서 위치에 삽입
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                range.insertNode(iconClone);
                
                // 커서를 아이콘 뒤로 이동
                range.setStartAfter(iconClone);
                range.setEndAfter(iconClone);
                selection.removeAllRanges();
                selection.addRange(range);
                
                showToast('아이콘이 본문에 삽입되었습니다');
            }
        }
        
        // Copy shape
        function copyShape(btn) {
            const shape = btn.closest('.shape-element');
            copiedShape = shape.cloneNode(true);
            showToast('도형이 복사되었습니다');
        }
        
        // Paste shape
        function pasteShape() {
            if (!copiedShape) return;
            
            const editorContent = document.querySelector('.editor-content');
            
            // 도형 복제
            const newShape = copiedShape.cloneNode(true);
            
            // 새로운 ID 부여
            newShape.id = `shape-${++shapeIdCounter}`;
            
            // 위치 조정 (원본에서 약간 오프셋)
            const currentLeft = parseInt(newShape.style.left) || 0;
            const currentTop = parseInt(newShape.style.top) || 0;
            newShape.style.left = (currentLeft + 20) + 'px';
            newShape.style.top = (currentTop + 20) + 'px';
            
            // 드래그 및 이벤트 다시 설정
            makeShapeDraggable(newShape);
            
            // 회전 핸들 이벤트 재설정
            const rotationHandle = newShape.querySelector('.rotation-handle');
            if (rotationHandle) {
                rotationHandle.addEventListener('mousedown', startShapeRotation);
            }
            
            // 리사이즈 핸들 이벤트 재설정
            const handles = newShape.querySelectorAll('.resize-handle');
            handles.forEach(handle => {
                handle.addEventListener('mousedown', startShapeResize);
            });
            
            // 에디터에 추가
            editorContent.appendChild(newShape);
            
            // 새 도형 선택
            selectShape(newShape);
            
            showToast('도형이 붙여넣기되었습니다');
        }
        
        // Delete shape
        function deleteShape(btn) {
            btn.closest('.shape-element').remove();
            selectedShape = null;
            showToast('도형이 삭제되었습니다');
        }
        
        // Open text color picker dialog
        function openTextColorPicker() {
            let selectedColor = document.getElementById('textColorCode')?.value || '#212529';
            
            // Save current selection
            const selection = window.getSelection();
            let savedRange = null;
            if (selection.rangeCount > 0) {
                savedRange = selection.getRangeAt(0).cloneRange();
            }
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            // Create dialog
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                padding: 12px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                max-width: 90%;
                width: 320px;
                max-height: 80vh;
                overflow-y: auto;
            `;

            // Title with preview
            const titleContainer = document.createElement('div');
            titleContainer.style.cssText = `
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 12px;
            `;
            
            const title = document.createElement('h3');
            title.textContent = '텍스트 색상 선택';
            title.style.cssText = `
                margin: 0;
                font-size: 16px;
                font-weight: bold;
                color: #333;
            `;
            
            const preview = document.createElement('div');
            preview.id = 'colorPreview';
            preview.style.cssText = `
                width: 24px;
                height: 24px;
                background: ${selectedColor};
                border-radius: 4px;
                border: 1px solid #ddd;
                box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            `;
            
            titleContainer.appendChild(title);
            titleContainer.appendChild(preview);
            dialog.appendChild(titleContainer);

            // Color grid
            const colorGrid = document.createElement('div');
            colorGrid.style.cssText = `
                display: grid;
                grid-template-columns: repeat(8, 1fr);
                gap: 6px;
                margin-bottom: 12px;
            `;

            // LEGO-style color blocks
            const legoColors = [
                // Basic colors
                { color: '#FF0000', name: '빨강' },
                { color: '#FF6B00', name: '주황' },
                { color: '#FFD700', name: '노랑' },
                { color: '#00FF00', name: '초록' },
                { color: '#00CED1', name: '청록' },
                { color: '#0000FF', name: '파랑' },
                { color: '#4B0082', name: '남색' },
                { color: '#9400D3', name: '보라' },
                
                // Pastel colors
                { color: '#FFB6C1', name: '연분홍' },
                { color: '#FFA07A', name: '연살구' },
                { color: '#FFFFE0', name: '연노랑' },
                { color: '#98FB98', name: '연초록' },
                { color: '#AFEEEE', name: '연하늘' },
                { color: '#ADD8E6', name: '연파랑' },
                { color: '#DDA0DD', name: '연보라' },
                { color: '#F0E68C', name: '카키' },
                
                // Dark colors
                { color: '#8B0000', name: '진빨강' },
                { color: '#FF8C00', name: '진주황' },
                { color: '#808000', name: '올리브' },
                { color: '#006400', name: '진초록' },
                { color: '#008B8B', name: '진청록' },
                { color: '#000080', name: '진파랑' },
                { color: '#4B0082', name: '인디고' },
                { color: '#800080', name: '진보라' },
                
                // Neutral colors
                { color: '#000000', name: '검정' },
                { color: '#696969', name: '진회색' },
                { color: '#808080', name: '회색' },
                { color: '#A9A9A9', name: '연회색' },
                { color: '#C0C0C0', name: '은색' },
                { color: '#D3D3D3', name: '밝은회색' },
                { color: '#DCDCDC', name: '게인즈버러' },
                { color: '#FFFFFF', name: '흰색' }
            ];

            legoColors.forEach(colorInfo => {
                const block = document.createElement('div');
                const color = colorInfo.color;
                
                // 3D LEGO block effect
                block.style.cssText = `
                    width: 100%;
                    aspect-ratio: 1;
                    background: ${color};
                    border-radius: 4px;
                    cursor: pointer;
                    position: relative;
                    transition: all 0.2s;
                    box-shadow: 
                        0 1px 0 0 ${adjustColor(color, -30)},
                        0 2px 0 0 ${adjustColor(color, -50)},
                        0 2px 4px rgba(0,0,0,0.2);
                    transform: translateY(0);
                    border: ${color === '#FFFFFF' ? '1px solid #e0e0e0' : 'none'};
                `;

                // Hover effect
                block.addEventListener('mouseenter', () => {
                    block.style.transform = 'translateY(-1px)';
                    block.style.boxShadow = `
                        0 2px 0 0 ${adjustColor(color, -30)},
                        0 3px 0 0 ${adjustColor(color, -50)},
                        0 3px 6px rgba(0,0,0,0.3)
                    `;
                });

                block.addEventListener('mouseleave', () => {
                    block.style.transform = 'translateY(0)';
                    block.style.boxShadow = `
                        0 1px 0 0 ${adjustColor(color, -30)},
                        0 2px 0 0 ${adjustColor(color, -50)},
                        0 2px 4px rgba(0,0,0,0.2)
                    `;
                });

                // Click event
                block.addEventListener('click', () => {
                    // Update selected color
                    selectedColor = color;
                    
                    // Update preview
                    const preview = document.getElementById('colorPreview');
                    if (preview) {
                        preview.style.background = color;
                    }
                    
                    // Update input field
                    colorInput.value = color.toUpperCase();
                    
                    // Add selected style to this block and remove from others
                    colorGrid.querySelectorAll('div').forEach(b => {
                        b.style.outline = 'none';
                    });
                    block.style.outline = '2px solid #007AFF';
                    block.style.outlineOffset = '2px';
                });

                // Tooltip
                block.title = colorInfo.name;

                colorGrid.appendChild(block);
            });

            dialog.appendChild(colorGrid);

            // Color code input
            const inputContainer = document.createElement('div');
            inputContainer.style.cssText = `
                margin-bottom: 12px;
            `;

            const colorInput = document.createElement('input');
            colorInput.type = 'text';
            colorInput.value = selectedColor;
            colorInput.placeholder = '#000000';
            colorInput.style.cssText = `
                width: 100%;
                padding: 6px 10px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 13px;
                font-family: monospace;
                box-sizing: border-box;
            `;

            // Real-time update on input
            colorInput.addEventListener('input', () => {
                const color = colorInput.value;
                if (/^#[0-9A-F]{6}$/i.test(color)) {
                    selectedColor = color;
                    // Update preview
                    const preview = document.getElementById('colorPreview');
                    if (preview) {
                        preview.style.background = color;
                    }
                    // Remove selection from color blocks
                    colorGrid.querySelectorAll('div').forEach(b => {
                        b.style.outline = 'none';
                    });
                }
            });

            inputContainer.appendChild(colorInput);
            dialog.appendChild(inputContainer);

            // Button container
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 8px;
                margin-top: 8px;
            `;

            // Save button
            const saveButton = document.createElement('button');
            saveButton.textContent = '저장';
            saveButton.style.cssText = `
                flex: 1;
                padding: 8px;
                background: #007AFF;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: bold;
            `;
            saveButton.addEventListener('click', () => {
                // Update text color button background
                const textColorButton = document.getElementById('textColorButton');
                if (textColorButton) {
                    textColorButton.style.background = selectedColor;
                    textColorButton.style.boxShadow = `
                        0 1px 0 0 ${adjustColor(selectedColor, -30)},
                        0 2px 0 0 ${adjustColor(selectedColor, -50)},
                        0 2px 4px rgba(0,0,0,0.2)
                    `;
                }
                // Update color code display
                const colorCode = document.getElementById('textColorCode');
                if (colorCode) {
                    colorCode.value = selectedColor.toUpperCase();
                }
                // Restore selection and apply color
                const editorContent = document.querySelector('.editor-content');
                if (editorContent) {
                    editorContent.focus();
                    
                    // Restore saved selection
                    if (savedRange) {
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(savedRange);
                    }
                    
                    // Apply color to text
                    applyFormat('color', selectedColor);
                    showToast('텍스트 색상이 적용되었습니다');
                    document.body.removeChild(overlay);
                } else {
                    showToast('에디터를 찾을 수 없습니다');
                }
            });
            buttonContainer.appendChild(saveButton);

            // Close button
            const closeButton = document.createElement('button');
            closeButton.textContent = '닫기';
            closeButton.style.cssText = `
                flex: 1;
                padding: 8px;
                background: #f0f0f0;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: bold;
            `;

            closeButton.addEventListener('click', () => {
                document.body.removeChild(overlay);
            });
            buttonContainer.appendChild(closeButton);

            dialog.appendChild(buttonContainer);

            // Overlay click to close
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // Focus on input
            colorInput.focus();
        }

        // Change shape color
        function changeShapeColor(btn) {
            const shape = btn.closest('.shape-element');
            
            // Create a color picker dialog
            const colorDialog = document.createElement('div');
            colorDialog.className = 'color-dialog';
            colorDialog.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--bg-primary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
            `;
            
            const currentColor = shape.dataset.currentColor || '#6c757d';
            
            colorDialog.innerHTML = `
                <h4 style="margin: 0 0 15px 0; font-size: 16px; color: var(--text-primary);"><span style="font-size: 14px;">🎨</span> Color Blocks</h4>
                
                <!-- LEGO-style color blocks -->
                <div id="colorBlocks" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; margin-bottom: 20px;">
                    <!-- Will be populated by JavaScript -->
                </div>
                
                <!-- Custom color section -->
                <div style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <div style="position: relative;">
                            <input type="color" id="shapeColorPicker" value="${currentColor}" 
                                   style="width: 50px; height: 50px; border: none; border-radius: 8px; cursor: pointer; 
                                          box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                            <div style="position: absolute; bottom: -2px; right: -2px; width: 20px; height: 20px; 
                                        background: white; border-radius: 50%; display: flex; align-items: center; 
                                        justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                <span style="font-size: 12px;">✎</span>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <input type="text" id="shapeColorCode" value="${currentColor.toUpperCase()}" 
                                   placeholder="#000000"
                                   style="width: 100%; padding: 10px; border: 2px solid var(--border-color); 
                                          border-radius: 8px; background: var(--bg-secondary); 
                                          color: var(--text-primary); font-family: monospace; font-size: 14px;
                                          transition: border-color 0.2s;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                                직접 색상 코드 입력
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="this.closest('.color-dialog').remove()" 
                            style="padding: 8px 20px; background: var(--bg-secondary); color: var(--text-primary); 
                                   border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;
                                   font-weight: 500; transition: all 0.2s;">
                        취소
                    </button>
                    <button id="applyShapeColor"
                            style="padding: 8px 20px; background: #007AFF; color: white; 
                                   border: none; border-radius: 8px; cursor: pointer; font-weight: 500;
                                   box-shadow: 0 2px 4px rgba(0, 122, 255, 0.3); transition: all 0.2s;">
                        적용
                    </button>
                </div>
            `;
            
            document.body.appendChild(colorDialog);
            
            // Define LEGO-style color palette
            const legoColors = [
                // First row - Basic colors
                { color: '#FF0000', name: '빨강' },
                { color: '#FF6B00', name: '주황' },
                { color: '#FFD600', name: '노랑' },
                { color: '#00D600', name: '초록' },
                { color: '#0096FF', name: '파랑' },
                { color: '#0047AB', name: '남색' },
                { color: '#8B00FF', name: '보라' },
                { color: '#FF1493', name: '분홍' },
                
                // Second row - Pastel colors
                { color: '#FFB3BA', name: '연분홍' },
                { color: '#FFDFBA', name: '연주황' },
                { color: '#FFFFBA', name: '연노랑' },
                { color: '#BAFFC9', name: '연초록' },
                { color: '#BAE1FF', name: '연파랑' },
                { color: '#C9BAFF', name: '연보라' },
                { color: '#E0BBE4', name: '라벤더' },
                { color: '#FFC0CB', name: '핑크' },
                
                // Third row - Dark colors
                { color: '#8B0000', name: '진빨강' },
                { color: '#FF8C00', name: '진주황' },
                { color: '#FFD700', name: '금색' },
                { color: '#228B22', name: '진초록' },
                { color: '#000080', name: '네이비' },
                { color: '#4B0082', name: '인디고' },
                { color: '#800080', name: '자주' },
                { color: '#DC143C', name: '크림슨' },
                
                // Fourth row - Neutral colors
                { color: '#000000', name: '검정' },
                { color: '#2F2F2F', name: '진회색' },
                { color: '#696969', name: '회색' },
                { color: '#A9A9A9', name: '밝은회색' },
                { color: '#D3D3D3', name: '연회색' },
                { color: '#FFFFFF', name: '흰색' },
                { color: '#8B4513', name: '갈색' },
                { color: '#D2691E', name: '초콜릿' }
            ];
            
            // Populate color blocks
            const colorBlocksContainer = document.getElementById('colorBlocks');
            legoColors.forEach(({ color, name }) => {
                const block = document.createElement('div');
                block.style.cssText = `
                    width: 100%;
                    aspect-ratio: 1;
                    background: ${color};
                    border-radius: 6px;
                    cursor: pointer;
                    position: relative;
                    transition: all 0.2s;
                    box-shadow: 
                        0 2px 0 0 ${adjustColor(color, -30)},
                        0 4px 0 0 ${adjustColor(color, -50)},
                        0 4px 8px rgba(0,0,0,0.2);
                    transform: translateY(0);
                `;
                
                // Add hover effect
                block.onmouseenter = function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = `
                        0 4px 0 0 ${adjustColor(color, -30)},
                        0 6px 0 0 ${adjustColor(color, -50)},
                        0 6px 12px rgba(0,0,0,0.3)
                    `;
                };
                
                block.onmouseleave = function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = `
                        0 2px 0 0 ${adjustColor(color, -30)},
                        0 4px 0 0 ${adjustColor(color, -50)},
                        0 4px 8px rgba(0,0,0,0.2)
                    `;
                };
                
                // Add click handler
                block.onclick = function() {
                    picker.value = color;
                    codeInput.value = color.toUpperCase();
                    
                    // Add selection effect
                    document.querySelectorAll('#colorBlocks > div').forEach(b => {
                        b.style.outline = 'none';
                    });
                    this.style.outline = '3px solid var(--primary)';
                    this.style.outlineOffset = '2px';
                };
                
                // Add tooltip
                block.title = name;
                
                colorBlocksContainer.appendChild(block);
            });
            
            // Helper function to adjust color brightness
            function adjustColor(color, amount) {
                const num = parseInt(color.replace('#', ''), 16);
                const r = Math.max(0, Math.min(255, (num >> 16) + amount));
                const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
                const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
                return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
            }
            
            const picker = document.getElementById('shapeColorPicker');
            const codeInput = document.getElementById('shapeColorCode');
            const applyBtn = document.getElementById('applyShapeColor');
            
            // Update code when picker changes
            picker.addEventListener('input', function() {
                codeInput.value = this.value.toUpperCase();
            });
            
            // Update picker when code changes
            codeInput.addEventListener('change', function() {
                const colorRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
                let code = this.value;
                
                if (!code.startsWith('#')) {
                    code = '#' + code;
                }
                
                if (colorRegex.test(code)) {
                    if (code.length === 4) {
                        code = '#' + code[1] + code[1] + code[2] + code[2] + code[3] + code[3];
                    }
                    picker.value = code;
                    this.value = code.toUpperCase();
                } else {
                    this.value = picker.value.toUpperCase();
                    showToast('올바른 색상 코드를 입력하세요 (예: #FF0000)');
                }
            });
            
            // Apply color
            applyBtn.addEventListener('click', function() {
                const selectedColor = picker.value;
                const svg = shape.querySelector('svg');
                const icon = shape.querySelector('i');
                
                if (svg) {
                    svg.querySelectorAll('*').forEach(el => {
                        if (el.hasAttribute('fill') && el.getAttribute('fill') !== 'none' && el.getAttribute('fill') !== 'currentColor') {
                            el.setAttribute('fill', selectedColor);
                        }
                        if (el.hasAttribute('stroke') && el.getAttribute('stroke') !== 'none' && el.getAttribute('stroke') !== 'currentColor') {
                            el.setAttribute('stroke', selectedColor);
                        }
                    });
                } else {
                    // For icons
                    const icon = shape.querySelector('i');
                    if (icon) {
                        icon.style.color = selectedColor;
                    }
                }
                
                // 색상 정보 저장
                shape.dataset.currentColor = selectedColor;
                
                // 현재 fill/stroke 모드 확인 후 적용
                const fillMode = shape.dataset.fillMode || 'fill';
                if (fillMode === 'stroke') {
                    // 테두리 모드일 때 색상 업데이트
                    if (svg) {
                        svg.querySelectorAll('*').forEach(el => {
                            if (el.hasAttribute('stroke')) {
                                el.setAttribute('stroke', selectedColor);
                            }
                        });
                    } else if (icon) {
                        icon.style.webkitTextStroke = '2px ' + selectedColor;
                    }
                }
                
                showToast('도형 색상이 변경되었습니다');
                colorDialog.remove();
            });
        }

        
        // Toggle shape fill/stroke
        function toggleShapeFill(btn) {
            const shape = btn.closest('.shape-element');
            const currentMode = shape.dataset.fillMode || 'fill';
            const newMode = currentMode === 'fill' ? 'stroke' : 'fill';
            shape.dataset.fillMode = newMode;
            
            const svg = shape.querySelector('svg');
            if (svg) {
                svg.querySelectorAll('*').forEach(el => {
                    if (el.hasAttribute('fill') || el.hasAttribute('stroke')) {
                        if (newMode === 'stroke') {
                            // 테두리만 표시
                            if (el.hasAttribute('fill')) {
                                el.setAttribute('fill', 'none');
                            }
                            if (el.hasAttribute('stroke')) {
                                const currentColor = shape.dataset.currentColor || '#6c757d';
                                el.setAttribute('stroke', currentColor);
                                el.setAttribute('stroke-width', '3');
                            }
                        } else {
                            // 채우기 표시
                            if (el.hasAttribute('fill')) {
                                const currentColor = shape.dataset.currentColor || '#6c757d';
                                el.setAttribute('fill', currentColor);
                            }
                            if (el.hasAttribute('stroke')) {
                                el.setAttribute('stroke', shape.dataset.currentColor || '#6c757d');
                                el.setAttribute('stroke-width', '3');
                            }
                        }
                    }
                });
            } else {
                // 아이콘의 경우
                const icon = shape.querySelector('i');
                if (icon) {
                    if (newMode === 'stroke') {
                        icon.style.webkitTextStroke = '2px ' + (shape.dataset.currentColor || '#6c757d');
                        icon.style.webkitTextFillColor = 'transparent';
                    } else {
                        icon.style.webkitTextStroke = 'none';
                        icon.style.webkitTextFillColor = shape.dataset.currentColor || '#6c757d';
                        icon.style.color = shape.dataset.currentColor || '#6c757d';
                    }
                }
            }
            
            showToast(`도형이 ${newMode === 'stroke' ? '테두리' : '채우기'} 모드로 변경되었습니다`);
        }
        
        // Shape rotation with handle
        let shapeRotating = false;
        let shapeRotationData = null;
        
        function startShapeRotation(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const shape = e.target.closest('.shape-element');
            const rect = shape.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const startAngle = Math.atan2(
                e.clientY - centerY,
                e.clientX - centerX
            ) * 180 / Math.PI;
            
            shapeRotating = true;
            shapeRotationData = {
                shape: shape,
                startAngle: startAngle,
                currentRotation: parseInt(shape.dataset.rotation) || 0,
                centerX: centerX,
                centerY: centerY
            };
            
            document.addEventListener('mousemove', doShapeRotation);
            document.addEventListener('mouseup', stopShapeRotation);
            document.body.style.cursor = 'grabbing';
        }
        
        function doShapeRotation(e) {
            if (!shapeRotating || !shapeRotationData) return;
            
            const rect = shapeRotationData.shape.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const currentAngle = Math.atan2(
                e.clientY - centerY,
                e.clientX - centerX
            ) * 180 / Math.PI;
            
            const deltaAngle = currentAngle - shapeRotationData.startAngle;
            const newRotation = Math.round(shapeRotationData.currentRotation + deltaAngle);
            
            shapeRotationData.shape.dataset.rotation = newRotation;
            shapeRotationData.shape.style.transform = `rotate(${newRotation}deg)`;
        }
        
        function stopShapeRotation() {
            shapeRotating = false;
            shapeRotationData = null;
            document.removeEventListener('mousemove', doShapeRotation);
            document.removeEventListener('mouseup', stopShapeRotation);
            document.body.style.cursor = '';
        }

        // Shape resize functionality
        let shapeResizing = false;
        let shapeResizeData = null;
        
        function startShapeResize(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const shape = e.target.closest('.shape-element');
            const handle = e.target.dataset.handle;
            
            shapeResizing = true;
            shapeResizeData = {
                shape: shape,
                handle: handle,
                startX: e.clientX,
                startY: e.clientY,
                startWidth: parseInt(shape.style.width),
                startHeight: parseInt(shape.style.height),
                startLeft: parseInt(shape.style.left) || 0,
                startTop: parseInt(shape.style.top) || 0
            };
            
            document.addEventListener('mousemove', doShapeResize);
            document.addEventListener('mouseup', stopShapeResize);
            document.body.style.cursor = getCursorForHandle(handle);
        }
        
        function doShapeResize(e) {
            if (!shapeResizing || !shapeResizeData) return;
            
            const dx = e.clientX - shapeResizeData.startX;
            const dy = e.clientY - shapeResizeData.startY;
            let newWidth = shapeResizeData.startWidth;
            let newHeight = shapeResizeData.startHeight;
            let newLeft = shapeResizeData.startLeft;
            let newTop = shapeResizeData.startTop;
            
            switch (shapeResizeData.handle) {
                case 'right':
                    // 우측 핸들 - 가로만 조절
                    newWidth = shapeResizeData.startWidth + dx;
                    break;
                case 'left':
                    // 좌측 핸들 - 가로만 조절
                    newWidth = shapeResizeData.startWidth - dx;
                    newLeft = shapeResizeData.startLeft + dx;
                    break;
                case 'bottom':
                    // 하단 핸들 - 세로만 조절
                    newHeight = shapeResizeData.startHeight + dy;
                    break;
                case 'top':
                    // 상단 핸들 - 세로만 조절
                    newHeight = shapeResizeData.startHeight - dy;
                    newTop = shapeResizeData.startTop + dy;
                    break;
                case 'bottom-right':
                case 'bottom-left':
                case 'top-right':
                case 'top-left':
                    // 모서리 핸들은 항상 비율 유지
                    const aspectRatio = shapeResizeData.startWidth / shapeResizeData.startHeight;
                    
                    if (shapeResizeData.handle === 'bottom-right') {
                        // 대각선 거리 계산
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const sign = (dx + dy) > 0 ? 1 : -1;
                        
                        newWidth = shapeResizeData.startWidth + (distance * sign);
                        newHeight = newWidth / aspectRatio;
                    } else if (shapeResizeData.handle === 'bottom-left') {
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const sign = (-dx + dy) > 0 ? 1 : -1;
                        
                        newWidth = shapeResizeData.startWidth + (distance * sign);
                        newHeight = newWidth / aspectRatio;
                        newLeft = shapeResizeData.startLeft + shapeResizeData.startWidth - newWidth;
                    } else if (shapeResizeData.handle === 'top-right') {
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const sign = (dx - dy) > 0 ? 1 : -1;
                        
                        newWidth = shapeResizeData.startWidth + (distance * sign);
                        newHeight = newWidth / aspectRatio;
                        newTop = shapeResizeData.startTop + shapeResizeData.startHeight - newHeight;
                    } else if (shapeResizeData.handle === 'top-left') {
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const sign = (-dx - dy) > 0 ? 1 : -1;
                        
                        newWidth = shapeResizeData.startWidth + (distance * sign);
                        newHeight = newWidth / aspectRatio;
                        newLeft = shapeResizeData.startLeft + shapeResizeData.startWidth - newWidth;
                        newTop = shapeResizeData.startTop + shapeResizeData.startHeight - newHeight;
                    }
                    break;
            }
            
            // Minimum size
            newWidth = Math.max(30, newWidth);
            newHeight = Math.max(30, newHeight);
            
            // Apply new dimensions
            shapeResizeData.shape.style.width = newWidth + 'px';
            shapeResizeData.shape.style.height = newHeight + 'px';
            shapeResizeData.shape.style.left = newLeft + 'px';
            shapeResizeData.shape.style.top = newTop + 'px';
        }
        
        function stopShapeResize() {
            shapeResizing = false;
            shapeResizeData = null;
            document.removeEventListener('mousemove', doShapeResize);
            document.removeEventListener('mouseup', stopShapeResize);
            document.body.style.cursor = '';
        }
        
        function getCursorForHandle(handle) {
            const cursors = {
                'top': 'ns-resize',
                'right': 'ew-resize',
                'bottom': 'ns-resize',
                'left': 'ew-resize',
                'top-left': 'nwse-resize',
                'top-right': 'nesw-resize',
                'bottom-left': 'nesw-resize',
                'bottom-right': 'nwse-resize'
            };
            return cursors[handle] || 'default';
        }
        
        // Set page margin
        function setPageMargin(preset) {
            const pages = document.querySelectorAll('.page');
            const customControls = document.getElementById('customMarginControls');
            
            switch(preset) {
                case 'normal':
                    pages.forEach(page => {
                        page.style.padding = '40px 60px';
                    });
                    customControls.style.display = 'none';
                    break;
                case 'narrow':
                    pages.forEach(page => {
                        page.style.padding = '30px 30px';
                    });
                    customControls.style.display = 'none';
                    break;
                case 'none':
                    pages.forEach(page => {
                        page.style.padding = '0px';
                    });
                    customControls.style.display = 'none';
                    break;
                case 'wide':
                    pages.forEach(page => {
                        page.style.padding = '60px 80px';
                    });
                    customControls.style.display = 'none';
                    break;
                case 'custom':
                    customControls.style.display = 'block';
                    updateCustomMargin();
                    break;
            }
            
            showToast('페이지 여백이 변경되었습니다');
        }
        
        // Update custom margin
        function updateCustomMargin() {
            const vertical = document.getElementById('marginVertical').value;
            const horizontal = document.getElementById('marginHorizontal').value;
            
            // Update display values
            document.getElementById('marginVerticalValue').textContent = vertical + 'px';
            document.getElementById('marginHorizontalValue').textContent = horizontal + 'px';
            
            // Apply to all pages
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.style.padding = `${vertical}px ${horizontal}px`;
            });
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initDocument();
            initTableCreator();
            
            // Click outside to deselect shapes and tables
            document.addEventListener('click', function(e) {
                // Check if click is outside shape elements
                if (!e.target.closest('.shape-element') && 
                    !e.target.closest('.shape-item') &&
                    !e.target.closest('.image-container') &&
                    !e.target.closest('.draggable-table')) {
                    // Deselect all shapes
                    document.querySelectorAll('.shape-element').forEach(shape => {
                        shape.classList.remove('selected');
                    });
                    selectedShape = null;
                    
                    // Deselect all tables
                    document.querySelectorAll('.draggable-table').forEach(table => {
                        table.classList.remove('selected');
                    });
                }
            });
        });
        
        // Table Creator Functions
        let selectedTableSize = { rows: 0, cols: 0 };
        let tableIdCounter = 0;
        
        function initTableCreator() {
            const selector = document.getElementById('tableSizeSelector');
            if (!selector) return;
            
            // Create 10x10 grid
            for (let row = 1; row <= 10; row++) {
                for (let col = 1; col <= 10; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'table-grid-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    cell.addEventListener('mouseenter', function() {
                        highlightTableGrid(row, col);
                    });
                    
                    cell.addEventListener('click', function() {
                        selectedTableSize = { rows: row, cols: col };
                        createTable();
                    });
                    
                    selector.appendChild(cell);
                }
            }
            
            selector.addEventListener('mouseleave', function() {
                clearTableGridHighlight();
            });
        }
        
        function highlightTableGrid(rows, cols) {
            const cells = document.querySelectorAll('.table-grid-cell');
            cells.forEach(cell => {
                const cellRow = parseInt(cell.dataset.row);
                const cellCol = parseInt(cell.dataset.col);
                if (cellRow <= rows && cellCol <= cols) {
                    cell.classList.add('highlighted');
                } else {
                    cell.classList.remove('highlighted');
                }
            });
            
            document.getElementById('tableSizeDisplay').textContent = `${rows} × ${cols}`;
        }
        
        function clearTableGridHighlight() {
            document.querySelectorAll('.table-grid-cell').forEach(cell => {
                cell.classList.remove('highlighted');
            });
            document.getElementById('tableSizeDisplay').textContent = '0 × 0';
        }
        
        function createTable() {
            if (selectedTableSize.rows === 0 || selectedTableSize.cols === 0) {
                showToast('표 크기를 선택해주세요');
                return;
            }
            
            const editorContent = document.querySelector('.editor-content');
            const table = document.createElement('table');
            table.className = 'draggable-table';
            table.id = `table-${++tableIdCounter}`;
            
            // Position table at center
            const editorRect = editorContent.getBoundingClientRect();
            table.style.left = '100px';
            table.style.top = '100px';
            
            // Create table rows and cells
            for (let i = 0; i < selectedTableSize.rows; i++) {
                const row = table.insertRow();
                for (let j = 0; j < selectedTableSize.cols; j++) {
                    const cell = row.insertCell();
                    cell.contentEditable = true;
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    
                    // 셀 더블클릭시 편집 가능하도록
                    cell.addEventListener('dblclick', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        // 편집 모드로 전환
                        this.contentEditable = true;
                        this.focus();
                        this.classList.add('editing');
                        this.style.cursor = 'text';
                        
                        // 텍스트 전체 선택
                        const range = document.createRange();
                        range.selectNodeContents(this);
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                    });
                    
                    // 셀에서 포커스 나갈 때
                    cell.addEventListener('blur', function() {
                        this.classList.remove('editing');
                        this.style.cursor = 'cell';
                    });
                    
                    // 엔터키로 편집 종료
                    cell.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.blur();
                        }
                    });
                }
            }
            
            // Add cell selection functionality
            setupTableCellSelection(table);
            
            // Add resize handles
            const rightHandle = document.createElement('div');
            rightHandle.className = 'table-resize-handle right';
            table.appendChild(rightHandle);
            
            const bottomHandle = document.createElement('div');
            bottomHandle.className = 'table-resize-handle bottom';
            table.appendChild(bottomHandle);
            
            const cornerHandle = document.createElement('div');
            cornerHandle.className = 'table-resize-handle corner';
            table.appendChild(cornerHandle);
            
            // Add table controls
            const controls = document.createElement('div');
            controls.className = 'table-controls';
            controls.innerHTML = `
                <button class="table-control-btn" onclick="addTableRow(this)" title="행 추가">
                    <i class="fas fa-plus"></i> 행
                </button>
                <button class="table-control-btn" onclick="removeTableRow(this)" title="행 제거">
                    <i class="fas fa-minus"></i> 행
                </button>
                <button class="table-control-btn" onclick="addTableColumn(this)" title="열 추가">
                    <i class="fas fa-plus"></i> 열
                </button>
                <button class="table-control-btn" onclick="removeTableColumn(this)" title="열 제거">
                    <i class="fas fa-minus"></i> 열
                </button>
                <button class="table-control-btn" onclick="openTableColorPicker(this)" title="셀 색상">
                    <i class="fas fa-palette"></i>
                </button>
                <button class="table-control-btn" onclick="deleteTable(this)" title="표 삭제">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            table.appendChild(controls);
            
            // Make table draggable
            makeTableDraggable(table);
            
            // Make table resizable
            makeTableResizable(table);
            
            // Setup table cell selection
            setupTableCellSelection(table);
            
            // Setup table spacing adjustment
            setupTableSpacing(table);
            
            // Add to editor
            editorContent.appendChild(table);
            
            // Select the table
            selectTable(table);
            
            // Show toast with correct values before reset
            showToast(`${selectedTableSize.rows}×${selectedTableSize.cols} 표가 삽입되었습니다`);
            
            // Reset selector
            selectedTableSize = { rows: 0, cols: 0 };
            clearTableGridHighlight();
        }
        
        function makeTableDraggable(table) {
            let isDragging = false;
            let startX, startY, startLeft, startTop;
            
            // Remove existing drag handle if any
            const existingHandle = table.querySelector('.table-drag-handle');
            if (existingHandle) {
                existingHandle.remove();
            }
            
            // Create new drag handle for table
            const dragHandle = document.createElement('div');
            dragHandle.className = 'table-drag-handle';
            dragHandle.style.cssText = `
                position: absolute;
                top: 2px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 8px;
                background: #666;
                color: white;
                text-align: center;
                line-height: 8px;
                font-size: 10px;
                cursor: grab;
                border-radius: 4px;
                user-select: none;
                opacity: 0;
                transition: opacity 0.2s;
                pointer-events: none;
                z-index: 1000;
            `;
            dragHandle.innerHTML = '⋯';
            table.appendChild(dragHandle);
            
            // Flag to track if mouse is over table or handle
            let mouseOverTable = false;
            let mouseOverHandle = false;
            
            function updateHandleVisibility() {
                if (mouseOverTable || mouseOverHandle || isDragging) {
                    dragHandle.style.opacity = '0.7';
                    dragHandle.style.pointerEvents = 'auto';
                } else {
                    dragHandle.style.opacity = '0';
                    dragHandle.style.pointerEvents = 'none';
                }
            }
            
            // Show/hide drag handle on hover
            table.addEventListener('mouseenter', function() {
                mouseOverTable = true;
                updateHandleVisibility();
            });
            
            table.addEventListener('mouseleave', function(e) {
                mouseOverTable = false;
                // Small delay to allow mouse to reach handle
                setTimeout(() => {
                    updateHandleVisibility();
                }, 100);
            });
            
            // Keep handle visible when hovering over it
            dragHandle.addEventListener('mouseenter', function() {
                mouseOverHandle = true;
                this.style.opacity = '1';
                updateHandleVisibility();
            });
            
            dragHandle.addEventListener('mouseleave', function(e) {
                mouseOverHandle = false;
                // Small delay to allow mouse to reach table
                setTimeout(() => {
                    updateHandleVisibility();
                }, 100);
            });
            
            const handleMouseDown = function(e) {
                // Only drag from the drag handle
                if (!e.target.classList.contains('table-drag-handle')) {
                    return;
                }
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startLeft = parseInt(table.style.left) || 0;
                startTop = parseInt(table.style.top) || 0;
                
                dragHandle.style.cursor = 'grabbing';
                selectTable(table);
                e.preventDefault();
                e.stopPropagation();
            };
            
            const handleMouseMove = function(e) {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                table.style.left = (startLeft + deltaX) + 'px';
                table.style.top = (startTop + deltaY) + 'px';
            };
            
            const handleMouseUp = function() {
                if (isDragging) {
                    isDragging = false;
                    dragHandle.style.cursor = 'grab';
                    // Update visibility after drag ends
                    updateHandleVisibility();
                }
            };
            
            // Add listeners only to drag handle
            dragHandle.addEventListener('mousedown', handleMouseDown);
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }
        
        function makeTableResizable(table) {
            const handles = table.querySelectorAll('.table-resize-handle');
            
            handles.forEach(handle => {
                let isResizing = false;
                let startX, startY, startWidth, startHeight;
                
                handle.addEventListener('mousedown', function(e) {
                    isResizing = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = table.offsetWidth;
                    startHeight = table.offsetHeight;
                    e.preventDefault();
                    e.stopPropagation();
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (!isResizing) return;
                    
                    if (handle.classList.contains('right')) {
                        const width = startWidth + (e.clientX - startX);
                        if (width > 100) {
                            table.style.width = width + 'px';
                        }
                    } else if (handle.classList.contains('bottom')) {
                        const height = startHeight + (e.clientY - startY);
                        if (height > 50) {
                            table.style.height = height + 'px';
                        }
                    } else if (handle.classList.contains('corner')) {
                        const width = startWidth + (e.clientX - startX);
                        const height = startHeight + (e.clientY - startY);
                        if (width > 100) {
                            table.style.width = width + 'px';
                        }
                        if (height > 50) {
                            table.style.height = height + 'px';
                        }
                    }
                });
                
                document.addEventListener('mouseup', function() {
                    isResizing = false;
                });
            });
        }
        
        function selectTable(table) {
            // Deselect all tables
            document.querySelectorAll('.draggable-table').forEach(t => {
                t.classList.remove('selected');
            });
            
            // Select this table
            table.classList.add('selected');
        }
        
        function selectTableCell(cell) {
            // Remove previous selection
            cell.closest('table').querySelectorAll('td').forEach(td => {
                td.classList.remove('selected-cell');
            });
            
            // Select this cell
            cell.classList.add('selected-cell');
        }
        
        function addTableRow(btn) {
            const table = btn.closest('.draggable-table');
            const row = table.insertRow();
            const colCount = table.rows[0].cells.length;
            
            for (let i = 0; i < colCount; i++) {
                const cell = row.insertCell();
                cell.contentEditable = true;
                cell.addEventListener('dblclick', function(e) {
                    e.stopPropagation();
                    this.contentEditable = true;
                    this.focus();
                    this.classList.add('editing');
                    
                    const range = document.createRange();
                    range.selectNodeContents(this);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                });
                
                cell.addEventListener('blur', function() {
                    this.classList.remove('editing');
                });
                
                cell.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.blur();
                    }
                });
            }
            
            showToast('행이 추가되었습니다');
        }
        
        function addTableColumn(btn) {
            const table = btn.closest('.draggable-table');
            const rows = table.rows;
            
            for (let i = 0; i < rows.length; i++) {
                const cell = rows[i].insertCell();
                cell.contentEditable = true;
                cell.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectTableCell(this);
                });
            }
            
            showToast('열이 추가되었습니다');
        }
        
        function removeTableRow(btn) {
            const table = btn.closest('.draggable-table');
            if (table.rows.length <= 1) {
                showToast('마지막 행은 삭제할 수 없습니다');
                return;
            }
            
            // 선택된 행 찾기
            const selectedCells = table.querySelectorAll('td.selected-cell');
            let rowsToRemove = new Set();
            
            selectedCells.forEach(cell => {
                rowsToRemove.add(cell.parentNode);
            });
            
            if (rowsToRemove.size === 0) {
                // 선택된 셀이 없으면 마지막 행 삭제
                table.deleteRow(table.rows.length - 1);
            } else {
                // 선택된 행들 삭제
                Array.from(rowsToRemove).forEach(row => {
                    row.remove();
                });
            }
            
            showToast('행이 제거되었습니다');
        }
        
        function removeTableColumn(btn) {
            const table = btn.closest('.draggable-table');
            const rows = table.rows;
            
            if (rows[0].cells.length <= 1) {
                showToast('마지막 열은 삭제할 수 없습니다');
                return;
            }
            
            // 선택된 열 찾기
            const selectedCells = table.querySelectorAll('td.selected-cell');
            let colsToRemove = new Set();
            
            selectedCells.forEach(cell => {
                colsToRemove.add(cell.cellIndex);
            });
            
            if (colsToRemove.size === 0) {
                // 선택된 셀이 없으면 마지막 열 삭제
                const lastColIndex = rows[0].cells.length - 1;
                for (let i = 0; i < rows.length; i++) {
                    rows[i].deleteCell(lastColIndex);
                }
            } else {
                // 선택된 열들 삭제 (큰 인덱스부터 삭제)
                const sortedCols = Array.from(colsToRemove).sort((a, b) => b - a);
                sortedCols.forEach(colIndex => {
                    for (let i = 0; i < rows.length; i++) {
                        if (rows[i].cells[colIndex]) {
                            rows[i].deleteCell(colIndex);
                        }
                    }
                });
            }
            
            showToast('열이 제거되었습니다');
        }
        
        function deleteTable(btn) {
            if (confirm('표를 삭제하시겠습니까?')) {
                const table = btn.closest('.draggable-table');
                table.remove();
                showToast('표가 삭제되었습니다');
            }
        }
        
        function openTableColorPicker(btn) {
            const table = btn.closest('.draggable-table');
            const selectedCells = table.querySelectorAll('td.selected-cell');
            
            if (selectedCells.length === 0) {
                showToast('색상을 변경할 셀을 선택해주세요');
                return;
            }
            
            // Create color picker dialog
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                max-width: 90%;
                width: 300px;
            `;
            
            dialog.innerHTML = `
                <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold;">셀 배경색</h3>
                <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px;">
                    <div class="color-option" style="width: 30px; height: 30px; background: #FFFFFF; border: 1px solid #ddd; cursor: pointer;" data-color="#FFFFFF"></div>
                    <div class="color-option" style="width: 30px; height: 30px; background: #F8F9FA; cursor: pointer;" data-color="#F8F9FA"></div>
                    <div class="color-option" style="width: 30px; height: 30px; background: #E9ECEF; cursor: pointer;" data-color="#E9ECEF"></div>
                    <div class="color-option" style="width: 30px; height: 30px; background: #DEE2E6; cursor: pointer;" data-color="#DEE2E6"></div>
                    <div class="color-option" style="width: 30px; height: 30px; background: #CED4DA; cursor: pointer;" data-color="#CED4DA"></div>
                    <div class="color-option" style="width: 30px; height: 30px; background: #ADB5BD; cursor: pointer;" data-color="#ADB5BD"></div>
                    <div class="color-option" style="width: 30px; height: 30px; background: #6C757D; cursor: pointer;" data-color="#6C757D"></div>
                    <div class="color-option" style="width: 30px; height: 30px; background: #343A40; cursor: pointer;" data-color="#343A40"></div>
                    
                    <div class="color-option" style="width: 30px; height: 30px; background: #F8D7DA; cursor: pointer;" data-color="#F8D7DA"></div>
                    <div class="color-option" style="width: 30px; height: 30px; background: #F5C2C7; cursor: pointer;" data-color="#F5C2C7"></div>
                    <div class="color-option" style="width: 30px; height: 30px; background: #FFF3CD; cursor: pointer;" data-color="#FFF3CD"></div>
                    <div class="color-option" style="width: 30px; height: 30px; background: #FFE69C; cursor: pointer;" data-color="#FFE69C"></div>
                    <div class="color-option" style="width: 30px; height: 30px; background: #D1ECF1; cursor: pointer;" data-color="#D1ECF1"></div>
                    <div class="color-option" style="width: 30px; height: 30px; background: #BEE5EB; cursor: pointer;" data-color="#BEE5EB"></div>
                    <div class="color-option" style="width: 30px; height: 30px; background: #D4EDDA; cursor: pointer;" data-color="#D4EDDA"></div>
                    <div class="color-option" style="width: 30px; height: 30px; background: #C3E6CB; cursor: pointer;" data-color="#C3E6CB"></div>
                </div>
                <button onclick="this.closest('div').parentElement.remove()" style="width: 100%; margin-top: 15px; padding: 8px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer;">닫기</button>
            `;
            
            dialog.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    const color = this.dataset.color;
                    selectedCells.forEach(cell => {
                        cell.style.backgroundColor = color;
                    });
                    overlay.remove();
                    showToast('셀 색상이 변경되었습니다');
                });
            });
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
        }
        
        // Setup table cell selection
        function setupTableCellSelection(table) {
            let isSelecting = false;
            let startCell = null;
            let endCell = null;
            
            // Prevent text selection during drag
            table.addEventListener('selectstart', function(e) {
                if (isSelecting) {
                    e.preventDefault();
                }
            });
            
            table.addEventListener('mousedown', function(e) {
                if (e.target.tagName === 'TD' && !e.target.closest('.table-drag-handle') && !e.target.closest('.table-controls')) {
                    const clickedCell = e.target;
                    
                    // Skip if cell is in editing mode
                    if (clickedCell.classList.contains('editing')) {
                        return;
                    }
                    
                    // Shift + Click for range selection
                    if (e.shiftKey && startCell) {
                        endCell = clickedCell;
                        updateCellSelection(table, startCell, endCell);
                    } else {
                        // Normal click or start of drag
                        isSelecting = true;
                        table.classList.add('selecting');
                        startCell = clickedCell;
                        endCell = clickedCell;
                        
                        // Clear previous selections if not holding Ctrl/Cmd
                        if (!e.ctrlKey && !e.metaKey) {
                            table.querySelectorAll('td').forEach(td => {
                                td.classList.remove('selected-cell');
                            });
                        }
                        
                        clickedCell.classList.add('selected-cell');
                    }
                    
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            
            table.addEventListener('mousemove', function(e) {
                if (isSelecting) {
                    const td = e.target.closest('td');
                    if (td && td.parentElement.parentElement === table) {
                        endCell = td;
                        updateCellSelection(table, startCell, endCell);
                    }
                }
            });
            
            table.addEventListener('mouseup', function() {
                if (isSelecting) {
                    isSelecting = false;
                    table.classList.remove('selecting');
                }
            });
            
            // Global mouseup to handle when mouse is released outside table
            document.addEventListener('mouseup', function() {
                if (isSelecting) {
                    isSelecting = false;
                    table.classList.remove('selecting');
                }
            });
            
            // Prevent context menu during selection
            table.addEventListener('contextmenu', function(e) {
                if (e.target.tagName === 'TD') {
                    e.preventDefault();
                }
            });
        }
        
        function updateCellSelection(table, startCell, endCell) {
            if (!startCell || !endCell) return;
            
            const startRow = parseInt(startCell.dataset.row);
            const startCol = parseInt(startCell.dataset.col);
            const endRow = parseInt(endCell.dataset.row);
            const endCol = parseInt(endCell.dataset.col);
            
            const minRow = Math.min(startRow, endRow);
            const maxRow = Math.max(startRow, endRow);
            const minCol = Math.min(startCol, endCol);
            const maxCol = Math.max(startCol, endCol);
            
            // Clear all selections and previews first
            table.querySelectorAll('td').forEach(td => {
                td.classList.remove('selected-cell', 'selection-preview');
            });
            
            // Select cells in range
            for (let row = minRow; row <= maxRow; row++) {
                for (let col = minCol; col <= maxCol; col++) {
                    const cell = table.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
                    if (cell) {
                        cell.classList.add('selected-cell');
                    }
                }
            }
            
            // Show selection info
            const selectedCount = (maxRow - minRow + 1) * (maxCol - minCol + 1);
            if (selectedCount > 1) {
                showSelectionInfo(`${selectedCount}개 셀 선택됨`);
            }
        }
        
        // Show selection info tooltip
        function showSelectionInfo(text) {
            let tooltip = document.getElementById('selection-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'selection-tooltip';
                tooltip.style.cssText = `
                    position: fixed;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    pointer-events: none;
                    z-index: 10000;
                    display: none;
                `;
                document.body.appendChild(tooltip);
            }
            
            tooltip.textContent = text;
            tooltip.style.display = 'block';
            
            // Position tooltip near mouse
            document.addEventListener('mousemove', function updateTooltipPosition(e) {
                tooltip.style.left = e.clientX + 10 + 'px';
                tooltip.style.top = e.clientY + 10 + 'px';
            });
            
            // Hide after selection ends
            setTimeout(() => {
                tooltip.style.display = 'none';
            }, 2000);
        }
        
        // Setup table spacing adjustment
        function setupTableSpacing(table) {
            const spacingHandles = document.createElement('div');
            spacingHandles.className = 'table-spacing-handles';
            spacingHandles.style.cssText = `
                position: absolute;
                top: -5px;
                left: -5px;
                right: -5px;
                bottom: -5px;
                pointer-events: none;
            `;
            
            // Create spacing adjustment handles for each side
            const positions = ['top', 'right', 'bottom', 'left'];
            positions.forEach(position => {
                const handle = document.createElement('div');
                handle.className = `spacing-handle spacing-${position}`;
                handle.style.cssText = `
                    position: absolute;
                    background: transparent;
                    pointer-events: auto;
                    ${position === 'top' || position === 'bottom' ? `
                        left: 20%;
                        right: 20%;
                        height: 10px;
                        cursor: ns-resize;
                        ${position}: -5px;
                    ` : `
                        top: 20%;
                        bottom: 20%;
                        width: 10px;
                        cursor: ew-resize;
                        ${position}: -5px;
                    `}
                `;
                
                // Add visual indicator on hover
                handle.addEventListener('mouseenter', function() {
                    this.style.background = 'rgba(0, 123, 255, 0.3)';
                });
                
                handle.addEventListener('mouseleave', function() {
                    this.style.background = 'transparent';
                });
                
                // Handle spacing adjustment
                let isAdjusting = false;
                let startPos = 0;
                let startMargin = 0;
                
                handle.addEventListener('mousedown', function(e) {
                    isAdjusting = true;
                    startPos = position === 'top' || position === 'bottom' ? e.clientY : e.clientX;
                    
                    // Get current margin
                    const computedStyle = window.getComputedStyle(table);
                    startMargin = parseInt(computedStyle[`margin${position.charAt(0).toUpperCase() + position.slice(1)}`]) || 0;
                    
                    e.preventDefault();
                    e.stopPropagation();
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (!isAdjusting) return;
                    
                    let delta;
                    if (position === 'top' || position === 'bottom') {
                        delta = e.clientY - startPos;
                        if (position === 'top') delta = -delta;
                    } else {
                        delta = e.clientX - startPos;
                        if (position === 'left') delta = -delta;
                    }
                    
                    const newMargin = Math.max(0, startMargin + delta);
                    table.style[`margin${position.charAt(0).toUpperCase() + position.slice(1)}`] = newMargin + 'px';
                });
                
                document.addEventListener('mouseup', function() {
                    isAdjusting = false;
                });
                
                spacingHandles.appendChild(handle);
            });
            
            table.appendChild(spacingHandles);
            
            // Show/hide spacing handles based on selection
            table.addEventListener('mouseenter', function() {
                if (this.classList.contains('selected')) {
                    spacingHandles.style.display = 'block';
                }
            });
            
            table.addEventListener('mouseleave', function() {
                spacingHandles.style.display = 'none';
            });
            
            // Initially hide spacing handles
            spacingHandles.style.display = 'none';
        }
        
        // Open background color picker
        function openBgColorPicker() {
            let selectedColor = document.getElementById('bgColorCode')?.value || '#FFFFFF';
            const savedRange = saveCurrentSelection();
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            // Create dialog
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                padding: 12px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                max-width: 90%;
                width: 320px;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            // Title with preview
            const titleContainer = document.createElement('div');
            titleContainer.style.cssText = `
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 12px;
            `;
            
            const title = document.createElement('h3');
            title.textContent = '배경 색상 선택';
            title.style.cssText = `
                margin: 0;
                font-size: 16px;
                font-weight: bold;
                color: #333;
            `;
            
            const preview = document.createElement('div');
            preview.id = 'bgColorPreview';
            preview.style.cssText = `
                width: 24px;
                height: 24px;
                background: ${selectedColor};
                border-radius: 4px;
                border: 1px solid #ddd;
                box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            `;
            
            titleContainer.appendChild(title);
            titleContainer.appendChild(preview);
            dialog.appendChild(titleContainer);
            
            // Color grid
            const colorGrid = document.createElement('div');
            colorGrid.style.cssText = `
                display: grid;
                grid-template-columns: repeat(8, 1fr);
                gap: 6px;
                margin-bottom: 12px;
            `;
            
            // Background colors
            const bgColors = [
                // Basic colors
                { color: '#FFFFFF', name: '흰색' },
                { color: '#F8F9FA', name: '연한 회색' },
                { color: '#E9ECEF', name: '회색' },
                { color: '#DEE2E6', name: '진한 회색' },
                { color: '#FFE5E5', name: '연분홍' },
                { color: '#FFE5CC', name: '연살구' },
                { color: '#FFFFCC', name: '연노랑' },
                { color: '#E5FFE5', name: '연초록' },
                
                { color: '#E5F3FF', name: '연하늘' },
                { color: '#E5E5FF', name: '연보라' },
                { color: '#FFE5F9', name: '연자주' },
                { color: '#F0F0F0', name: '밝은 회색' },
                { color: '#FFCCCC', name: '분홍' },
                { color: '#FFD9B3', name: '살구' },
                { color: '#FFFF99', name: '노랑' },
                { color: '#CCFFCC', name: '초록' },
                
                { color: '#CCE5FF', name: '하늘' },
                { color: '#CCCCFF', name: '보라' },
                { color: '#FFCCF2', name: '자주' },
                { color: '#D0D0D0', name: '중간 회색' },
                { color: '#FF9999', name: '진분홍' },
                { color: '#FFB366', name: '진살구' },
                { color: '#FFFF66', name: '진노랑' },
                { color: '#99FF99', name: '진초록' },
                
                { color: '#99CCFF', name: '진하늘' },
                { color: '#9999FF', name: '진보라' },
                { color: '#FF99E5', name: '진자주' },
                { color: '#A0A0A0', name: '어두운 회색' },
                { color: '#FF6666', name: '빨강' },
                { color: '#FF9933', name: '주황' },
                { color: '#FFFF33', name: '밝은 노랑' },
                { color: '#66FF66', name: '밝은 초록' }
            ];
            
            bgColors.forEach(colorInfo => {
                const block = document.createElement('div');
                const color = colorInfo.color;
                
                // 3D LEGO block effect
                block.style.cssText = `
                    width: 100%;
                    aspect-ratio: 1;
                    background: ${color};
                    border-radius: 4px;
                    cursor: pointer;
                    position: relative;
                    transition: all 0.2s;
                    box-shadow: 
                        0 1px 0 0 ${adjustColor(color, -30)},
                        0 2px 0 0 ${adjustColor(color, -50)},
                        0 2px 4px rgba(0,0,0,0.2);
                    transform: translateY(0);
                    border: ${color === '#FFFFFF' ? '1px solid #e0e0e0' : 'none'};
                `;
                
                // Hover effect
                block.addEventListener('mouseenter', () => {
                    block.style.transform = 'translateY(-1px)';
                    block.style.boxShadow = `
                        0 2px 0 0 ${adjustColor(color, -30)},
                        0 3px 0 0 ${adjustColor(color, -50)},
                        0 3px 6px rgba(0,0,0,0.3)
                    `;
                });
                
                block.addEventListener('mouseleave', () => {
                    block.style.transform = 'translateY(0)';
                    block.style.boxShadow = `
                        0 1px 0 0 ${adjustColor(color, -30)},
                        0 2px 0 0 ${adjustColor(color, -50)},
                        0 2px 4px rgba(0,0,0,0.2)
                    `;
                });
                
                // Click event
                block.addEventListener('click', () => {
                    selectedColor = color;
                    const preview = document.getElementById('bgColorPreview');
                    if (preview) {
                        preview.style.background = color;
                    }
                    
                    colorInput.value = color.toUpperCase();
                    
                    colorGrid.querySelectorAll('div').forEach(b => {
                        b.style.outline = 'none';
                    });
                    block.style.outline = '2px solid #007AFF';
                    block.style.outlineOffset = '2px';
                });
                
                block.title = colorInfo.name;
                colorGrid.appendChild(block);
            });
            
            dialog.appendChild(colorGrid);
            
            // Color code input
            const inputContainer = document.createElement('div');
            inputContainer.style.cssText = `
                margin-bottom: 12px;
            `;
            
            const colorInput = document.createElement('input');
            colorInput.type = 'text';
            colorInput.value = selectedColor;
            colorInput.placeholder = '#FFFFFF';
            colorInput.style.cssText = `
                width: 100%;
                padding: 6px 10px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 13px;
                font-family: monospace;
                box-sizing: border-box;
            `;
            
            colorInput.addEventListener('input', () => {
                const color = colorInput.value;
                if (/^#[0-9A-F]{6}$/i.test(color)) {
                    selectedColor = color;
                    const preview = document.getElementById('bgColorPreview');
                    if (preview) {
                        preview.style.background = color;
                    }
                    
                    colorGrid.querySelectorAll('div').forEach(b => {
                        b.style.outline = 'none';
                    });
                }
            });
            
            inputContainer.appendChild(colorInput);
            dialog.appendChild(inputContainer);
            
            // Button container
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 8px;
                margin-top: 8px;
            `;
            
            // Save button
            const saveButton = document.createElement('button');
            saveButton.textContent = '저장';
            saveButton.style.cssText = `
                flex: 1;
                padding: 8px;
                background: #007AFF;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: bold;
            `;
            saveButton.addEventListener('click', () => {
                // Apply to selected table cells
                const selectedCells = document.querySelectorAll('.draggable-table td.selected-cell');
                if (selectedCells.length > 0) {
                    selectedCells.forEach(cell => {
                        cell.style.backgroundColor = selectedColor;
                    });
                    showToast('표 셀 배경색이 적용되었습니다');
                } else if (savedRange) {
                    // Apply to text selection
                    restoreSelection(savedRange);
                    applyFormat('backgroundColor', selectedColor);
                    showToast('텍스트 배경색이 적용되었습니다');
                }
                
                // Update button and input
                const bgColorButton = document.getElementById('bgColorButton');
                if (bgColorButton) {
                    bgColorButton.style.background = selectedColor;
                    bgColorButton.style.boxShadow = `
                        0 1px 0 0 ${adjustColor(selectedColor, -30)},
                        0 2px 0 0 ${adjustColor(selectedColor, -50)},
                        0 2px 4px rgba(0,0,0,0.2)
                    `;
                }
                const bgColorCode = document.getElementById('bgColorCode');
                if (bgColorCode) {
                    bgColorCode.value = selectedColor.toUpperCase();
                }
                
                document.body.removeChild(overlay);
            });
            buttonContainer.appendChild(saveButton);
            
            // Close button
            const closeButton = document.createElement('button');
            closeButton.textContent = '닫기';
            closeButton.style.cssText = `
                flex: 1;
                padding: 8px;
                background: #f0f0f0;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: bold;
            `;
            closeButton.addEventListener('click', () => {
                document.body.removeChild(overlay);
            });
            buttonContainer.appendChild(closeButton);
            
            dialog.appendChild(buttonContainer);
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            colorInput.focus();
        }
        
        // Save and restore selection
        function saveCurrentSelection() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                return selection.getRangeAt(0).cloneRange();
            }
            return null;
        }
        
        function restoreSelection(range) {
            if (range) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }
        
        // Update color from code
        function updateColorFromCode(type, code) {
            if (/^#[0-9A-F]{6}$/i.test(code)) {
                if (type === 'bg') {
                    const bgColorButton = document.getElementById('bgColorButton');
                    if (bgColorButton) {
                        bgColorButton.style.background = code;
                        bgColorButton.style.boxShadow = `
                            0 1px 0 0 ${adjustColor(code, -30)},
                            0 2px 0 0 ${adjustColor(code, -50)},
                            0 2px 4px rgba(0,0,0,0.2)
                        `;
                    }
                    document.getElementById('bgColor').value = code;
                }
            }
        }
    </script>
</body>
</html>